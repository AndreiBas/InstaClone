<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta-Clone Calculator (Secure Cloud)</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pako.js for compression/decompression for sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- Load Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        html, body { overscroll-behavior-y: contain; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

        /* Styles for the dual-layer input area */
        .input-container { position: relative; flex: 1; min-height: 0; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 1rem; line-height: 1.5; }
        @media (min-width: 768px) { .input-container { font-size: 1.125rem; } }

        #highlightingArea, #inputArea, #autocomplete-mirror { padding: 1rem; margin: 0; border: 0; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; position: absolute; top: 0; right: 0; bottom: 0; left: 0; border-radius: 0.75rem; font: inherit; }
        #highlightingArea { background-color: #111827; z-index: 1; pointer-events: none; color: #d1d5db; }
        #highlightingArea > div { min-height: 1.5em; }
        #inputArea { z-index: 2; background-color: transparent; color: transparent; caret-color: #fff; resize: none; outline: none; }
        #autocomplete-mirror { z-index: -1; visibility: hidden; pointer-events: none; }

        /* Syntax Highlighting */
        .variable-new { color: #60a5fa; } .variable-redefined { color: #f87171; } .variable-used { color: #fb923c; } .comment { color: #facc15; } .operator { color: #a1a1aa; } .keyword { color: #c084fc; } .unit { color: #2dd4bf; }
        
        /* Autocomplete Popup */
        #autocomplete-popup { position: absolute; z-index: 100; background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); max-height: 200px; overflow-y: auto; min-width: 150px; }
        .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; color: #d1d5db; }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: #4f46e5; color: white; }
        
        /* Toggles */
        .toggle-switch-container { display: inline-block; height: 24px; position: relative; width: 48px; }
        .toggle-switch-container input { display: none; }
        .toggle-slider { background-color: #4b5563; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { background-color: white; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #22c55e; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Loops */
        .loop-header { cursor: pointer; display: flex; align-items: center; }
        .toggle-icon { margin-right: 0.5rem; color: #9ca3af; transition: transform 0.2s; width: 1rem; }
        .toggle-icon.expanded { transform: rotate(90deg); }
        
        /* Help & Variables */
        #help-content h5, #variables-content h5 { font-size: 1.125rem; font-weight: 600; color: #c084fc; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.25rem; }
        #help-content h5:first-child { margin-top: 0; }
        #help-content code { display: block; background-color: #111827; padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; color: #9ca3af; border: 1px solid #374151; }
        #help-content p { margin-bottom: 0.5rem; line-height: 1.6; }
        #help-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #d1d5db; }
        #help-content li { margin-bottom: 0.25rem; }
        #help-content strong { color: #e5e7eb; }
        
        /* Interactive Lines */
        .line-highlight { background-color: rgba(75, 85, 99, 0.5); transition: background-color 0.1s ease-in-out; }
        .output-line { cursor: pointer; }
        .variable-row { cursor: pointer; border-radius: 0.25rem; transition: background-color 0.2s ease-in-out; }
        .variable-row:hover { background-color: rgba(75, 85, 99, 0.5); }
        .rename-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; margin-left: 0.5rem; color: #9ca3af; }
        .rename-btn:hover { color: #e5e7eb; }
        .variable-name-cell input { background-color: #374151; color: #e5e7eb; border: 1px solid #4f46e5; border-radius: 0.25rem; padding: 0 0.25rem; width: 100%; font: inherit; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased flex flex-col items-center min-h-screen p-2 sm:p-4">

    <!-- Main Content -->
    <div class="w-full max-w-screen-2xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden grid grid-rows-2 md:grid-rows-1 md:grid-cols-2 flex-1 min-h-0 md:max-h-[80vh]">
        <!-- Input -->
        <div class="flex flex-col p-4 md:p-8 min-h-0">
            <div class="flex justify-between items-center mb-2 h-12 gap-2 md:gap-4 flex-shrink-0">
                <input type="text" id="calculationNameInput" placeholder="Calculation Name..." class="text-xl md:text-2xl font-bold text-white bg-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 py-1 w-full -ml-2">
                <button id="eraseButton" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 flex-shrink-0">Erase</button>
            </div>
            <div class="input-container">
                <div id="highlightingArea" aria-hidden="true"></div>
                <div id="autocomplete-mirror" aria-hidden="true"></div>
                <textarea id="inputArea" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off"></textarea>
                <div id="autocomplete-popup" class="hidden"></div>
            </div>
        </div>
        <!-- Results -->
        <div class="flex flex-col p-4 md:p-8 border-t-2 md:border-t-0 md:border-l-2 border-gray-700 bg-gray-700/30 min-h-0">
            <div class="flex justify-between items-center mb-2 min-h-[3rem] h-auto flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">Results</h2>
                <div class="flex items-center justify-end flex-wrap gap-x-4 gap-y-2">
                    <div class="flex items-center space-x-2"><label class="text-gray-400 text-sm">Clean view</label><label class="toggle-switch-container"><input type="checkbox" id="cleanViewToggle"><span class="toggle-slider"></span></label></div>
                    <div class="flex items-center space-x-2"><label class="text-gray-400 text-sm">No sleep</label><label class="toggle-switch-container"><input type="checkbox" id="noSleepToggle"><span class="toggle-slider"></span></label></div>
                    <div class="flex items-center space-x-2"><label class="text-gray-400 text-sm">Round</label><label class="toggle-switch-container"><input type="checkbox" id="roundingToggle"><span class="toggle-slider"></span></label></div>
                </div>
            </div>
            <div id="outputArea" class="relative flex-1 bg-gray-900 rounded-xl p-4 overflow-y-auto text-gray-200 font-mono text-base md:text-lg">
                <div class="text-gray-400">Your results will appear here in real-time.</div>
            </div>
        </div>
    </div>

    <!-- Mobile Controls Toggle -->
    <div class="w-full max-w-screen-2xl mt-2 md:hidden">
        <button id="toggleControlsButton" class="w-full bg-gray-700 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-gray-600">Manage Saves & Files</button>
    </div>

    <!-- Controls Panel -->
    <div id="controls-panel" class="w-full max-w-screen-2xl mt-4 p-4 md:p-6 bg-gray-800 rounded-2xl shadow-2xl hidden md:block">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                Global Cloud Slots (Supabase)
                <span id="cloud-status-badge" class="text-xs font-normal text-gray-400 border border-gray-500 px-2 py-0.5 rounded-full flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                    Locked
                </span>
            </h3>
        </div>
        
        <!-- Unified Cloud Slots Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
            <!-- Slot 1 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-1">
                <button id="save-1" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-1">
                    <span id="slot-text-1" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-1" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
            <!-- Slot 2 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-2">
                <button id="save-2" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-2">
                    <span id="slot-text-2" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-2" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
            <!-- Slot 3 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-3">
                <button id="save-3" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-3">
                    <span id="slot-text-3" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-3" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
            <!-- Slot 4 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-4">
                <button id="save-4" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-4">
                    <span id="slot-text-4" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-4" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
            <!-- Slot 5 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-5">
                <button id="save-5" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-5">
                    <span id="slot-text-5" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-5" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
            <!-- Slot 6 -->
            <div class="flex items-stretch bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700 shadow-sm transition-colors duration-200" id="slot-row-6">
                <button id="save-6" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-r border-gray-600 focus:outline-none z-10">SAVE</button>
                <div class="flex-1 flex items-center justify-center px-2 py-2 overflow-hidden transition-colors duration-200" id="slot-mid-6">
                    <span id="slot-text-6" class="text-gray-500 text-sm font-medium truncate select-none">Locked</span>
                </div>
                <button id="load-6" class="px-4 bg-gray-700 text-gray-400 font-medium text-sm transition-colors border-l border-gray-600 focus:outline-none z-10">LOAD</button>
            </div>
        </div>
        
        <div class="mt-4 flex flex-wrap justify-center gap-2">
            <button id="saveToFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Save to File</button>
            <button id="loadFromFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Load from File</button>
            <button id="shareButton" class="bg-teal-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 flex-grow sm:flex-grow-0">Share Link</button>
            <button id="variablesButton" class="bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 flex-grow sm:flex-grow-0">Variables</button>
            <button id="helpButton" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-purple-700 flex-grow sm:flex-grow-0">Help</button>
        </div>
        <input type="file" id="fileLoader" class="hidden" accept=".txt,.text/plain,.json">
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-gray-700">
            <h4 id="confirm-title" class="text-xl font-bold mb-4">Overwrite Calculation?</h4>
            <p id="confirm-text" class="text-gray-400 mb-6">Do you want to overwrite this?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel" class="bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl border border-gray-700">
            <div class="flex items-center justify-center mb-4 text-purple-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <h4 class="text-xl font-bold mb-2 text-center text-white">Security Check</h4>
            <p class="text-gray-400 mb-4 text-center text-sm">Enter the master password to access Cloud Slots. This will be verified securely by Supabase.</p>
            <input type="password" id="passwordInput" placeholder="Enter Password" class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-4 focus:ring-2 focus:ring-purple-500 focus:outline-none">
            <div class="flex justify-end gap-3">
                <button id="password-cancel" class="bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="password-submit" class="bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700">Unlock</button>
            </div>
            <p id="password-error" class="text-red-400 text-sm mt-2 text-center hidden">Incorrect password.</p>
        </div>
    </div>

    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-lg shadow-lg z-50 hidden opacity-0 transition-opacity duration-300"><p id="message-text"></p></div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-3xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
            <h4 class="text-2xl font-bold mb-4 text-white">Calculator Guide</h4>
            <div id="help-content" class="flex-1 overflow-y-auto text-gray-300 space-y-4 pr-4"></div>
            <div class="flex justify-end mt-6"><button id="help-close-button" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-purple-700">Got it!</button></div>
        </div>
    </div>

    <!-- Variables Modal -->
    <div id="variables-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
            <h4 class="text-2xl font-bold mb-4 text-white">Current Variables</h4>
            <div id="variables-content" class="flex-1 overflow-y-auto text-gray-300 space-y-2 pr-4 font-mono"></div>
            <div class="flex justify-end mt-6"><button id="variables-close-button" class="bg-cyan-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-cyan-700">Close</button></div>
        </div>
    </div>

    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://erceyiltzqsshwqdueuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyY2V5aWx0enFzc2h3cWR1ZXVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MTMwNTQsImV4cCI6MjA4MDA4OTA1NH0.Oy9gppo_HDIBE3u9ugdlR5f71np188KYoSKLihi7wY0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Core Application Logic ---
        
        const $ = (selector) => document.querySelector(selector);
        
        const inputArea = $('#inputArea');
        const highlightingArea = $('#highlightingArea');
        const outputArea = $('#outputArea');
        const eraseButton = $('#eraseButton');
        const calculationNameInput = $('#calculationNameInput');
        const autocompletePopup = $('#autocomplete-popup');
        const confirmModal = $('#confirm-modal');
        const messageBox = $('#message-box');
        const roundingToggle = $('#roundingToggle');
        const noSleepToggle = $('#noSleepToggle');
        const cleanViewToggle = $('#cleanViewToggle');
        const helpButton = $('#helpButton');
        const helpModal = $('#help-modal');
        const helpContent = $('#help-content');
        const helpCloseButton = $('#help-close-button');
        const saveToFileButton = $('#saveToFileButton');
        const loadFromFileButton = $('#loadFromFileButton');
        const fileLoaderInput = $('#fileLoader');
        const shareButton = $('#shareButton');
        const toggleControlsButton = $('#toggleControlsButton');
        const controlsPanel = $('#controls-panel');
        const variablesButton = $('#variablesButton');
        const variablesModal = $('#variables-modal');
        const variablesContent = $('#variables-content');
        const variablesCloseButton = $('#variables-close-button');
        
        // Security Elements
        const passwordModal = $('#password-modal');
        const passwordInput = $('#passwordInput');
        const passwordSubmit = $('#password-submit');
        const passwordCancel = $('#password-cancel');
        const passwordError = $('#password-error');
        const cloudStatusBadge = $('#cloud-status-badge');

        let variables = {};
        let orderedVariables = new Map();
        let wakeLock = null;
        let autocompleteState = { active: false, suggestions: [], selectedIndex: -1, wordStartIndex: -1, currentWord: '' };
        let isCloudUnlocked = false; 
        let pendingCloudAction = null; 
        let cloudSlotMetadata = {}; 
        
        const HELP_CONTENT_INPUT = `// Example with a loop and dynamic comment\ntotal_sum = 0\nfor i = 1 to 3\n  total_sum = total_sum + i // running total is {total_sum}\nendfor\n\nHiddenBlock\n  // This block is for setup and won't show in Clean View\n  adjustment_factor = 1.1\nHiddenEnd\n\n// Final result is {total_sum}.\nfinal_value = total_sum ^ 2 * adjustment_factor`;
        
        const HELP_CONTENT_POPUP_HTML = `
            <p>Welcome to Insta-Clone! This is a "literal calculator" that blends a notepad with a spreadsheet. Type your calculations in natural language, define variables, and see results update in real-time.</p>
            
            <h5>1. Basic Math & Arithmetic</h5>
            <p>Use standard operators or parentheses for grouping. The result appears in the right sidebar.</p>
            <code>2 + 2\n(10 * 5) / 2\n2^3  // Exponent (2 to the power of 3)</code>

            <h5>2. Variables</h5>
            <p>Assign a value to a word using <code>=</code>. You can use that word in later lines. Variable names are <strong>not case-sensitive</strong> (e.g., 'Rent' and 'rent' are the same).</p>
            <code>Salary = 5000\nTax = 0.2\nNet_Pay = Salary * (1 - Tax)</code>
            <p><em>Tip: Click the <strong>Variables</strong> button to see a list of all active variables and rename them globally.</em></p>

            <h5>3. Comments & Clean View</h5>
            <p>Use <code>//</code> to add notes. If you turn on <strong>Clean View</strong> (toggle at top right), the raw math is hidden, and only your text and results remain.</p>
            <p>You can embed values into comments using curly braces <code>{}</code>:</p>
            <code>total = 150 // The final total is {total} dollars.</code>

            <h5>4. Percentages</h5>
            <p>Easily calculate percentages or add/subtract them.</p>
            <code>50% of 200      // Result: 100\n100 + 20%       // Result: 120 (Adds 20% of 100)\n500 - 10%       // Result: 450</code>

            <h5>5. Unit & Currency Conversions</h5>
            <p>Convert between supported units using the <code>to</code> keyword.</p>
            <code>100 USD to EUR\n50 GBP to USD\n10 m to ft\n100 cm to inch\n5 kg to lb</code>

            <h5>6. Date Math</h5>
            <p>Calculate future or past dates using <code>today</code>.</p>
            <code>today + 2 weeks\ntoday - 5 days\ntoday + 1 year</code>

            <h5>7. Math Functions & Constants</h5>
            <p>Advanced math is supported using standard function names:</p>
            <ul>
                <li><strong>Constants:</strong> <code>pi</code> (3.14159...), <code>e</code> (2.718...)</li>
                <li><strong>Trigonometry:</strong> <code>sin(x)</code>, <code>cos(x)</code>, <code>tan(x)</code> (input in radians)</li>
                <li><strong>General:</strong> <code>sqrt(x)</code> (Square Root), <code>abs(x)</code> (Absolute Value)</li>
                <li><strong>Rounding:</strong> <code>round(x)</code>, <code>floor(x)</code>, <code>ceil(x)</code></li>
            </ul>
            <code>radius = 5\narea = pi * radius^2\nhypotenuse = sqrt(3^2 + 4^2)</code>

            <h5>8. Automation (Loops)</h5>
            <p>Run a block of code multiple times. Useful for compound interest or growing lists.</p>
            <code>total = 0\nfor i = 1 to 5\n  total = total + i\nendfor</code>
            <p><em>In the Results panel, click the arrow (►) to expand or collapse loop details.</em></p>

            <h5>9. Cloud Saving (Secure)</h5>
            <p>There are 6 global cloud slots available. These are stored online in a Supabase database.</p>
            <ul>
                <li><strong>Security:</strong> Access is protected by a master password.</li>
                <li><strong>Shared Access:</strong> Anyone with the password and API key can see these slots (useful for teams).</li>
                <li><strong>Overwrite Protection:</strong> The app will warn you before overwriting an existing save.</li>
            </ul>
            
            <h5>10. Shortcuts</h5>
            <ul>
                <li><strong>Erase:</strong> Clears the screen.</li>
                <li><strong>Share:</strong> Generates a URL to send your calculation to others.</li>
                <li><strong>No Sleep:</strong> Keeps your screen awake (great for presentations).</li>
                <li><strong>Click Results:</strong> Clicking a line in the results panel scrolls to that line in the editor.</li>
            </ul>
        `;

        const inchRates = { cm: 2.54, m: 0.0254, ft: 1/12 };
        const conversionRates = {
            usd: { eur: 0.92, gbp: 0.78 }, eur: { usd: 1.09, gbp: 0.85 }, gbp: { usd: 1.28, eur: 1.17 },
            m: { ft: 3.28084, cm: 100, in: 39.3701, inch: 39.3701 }, ft: { m: 0.3048, cm: 30.48, in: 12, inch: 12 }, cm: { m: 0.01, ft: 0.0328084, in: 0.393701, inch: 0.393701 }, in: inchRates, inch: inchRates,
            kg: { lb: 2.20462 }, lb: { kg: 0.453592 },
        };

        const specialWords = {
            'today': 'keyword', 'to': 'keyword', 'for': 'keyword', 'endfor': 'keyword', 'of': 'keyword',
            'hiddenblock': 'keyword', 'hiddenend': 'keyword',
            'usd': 'unit', 'eur': 'unit', 'gbp': 'unit', 'm': 'unit', 'ft': 'unit', 'cm': 'unit', 'kg': 'unit', 'lb': 'unit', 'in': 'unit', 'inch': 'unit',
            'days': 'unit', 'day': 'unit', 'weeks': 'unit', 'week': 'unit', 'months': 'unit', 'month': 'unit', 'years': 'unit', 'year': 'unit', 'hours': 'unit', 'hour': 'unit', 'minutes': 'unit', 'minute': 'unit',
        };

        // --- Helper Functions ---
        const setDefaultCalculationName = () => { const today = new Date(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); const yy = today.getFullYear().toString().slice(-2); calculationNameInput.value = `Insta-Clone ${mm}-${dd}-${yy}`; };
        const showMessage = (text) => { $('#message-text').textContent = text; messageBox.classList.remove('hidden'); setTimeout(() => messageBox.classList.remove('opacity-0'), 10); setTimeout(() => { messageBox.classList.add('opacity-0'); setTimeout(() => messageBox.classList.add('hidden'), 3000); }, 3000); };
        
        const interpolateComment = (comment, vars) => {
            if (!comment) return comment;
            return comment.replace(/{([a-zA-Z_]\w*)}/g, (match, varName) => {
                const lowerVarName = varName.toLowerCase();
                if (vars.hasOwnProperty(lowerVarName)) {
                    return formatResult(vars[lowerVarName]);
                }
                return match;
            });
        };

        const scrollToLine = (lineIndex) => {
            const lines = inputArea.value.split('\n');
            if (lineIndex < 0 || lineIndex >= lines.length) return;
            let charIndex = 0;
            for (let i = 0; i < lineIndex; i++) {
                charIndex += lines[i].length + 1;
            }
            inputArea.focus();
            inputArea.setSelectionRange(charIndex, charIndex);
            const targetLineDiv = $(`#highlightingArea [data-line-id="${lineIndex}"]`);
            if (targetLineDiv) { inputArea.scrollTo({ top: targetLineDiv.offsetTop, behavior: 'auto' }); }
        };

        // --- Core Calculation Engine ---
        const calculate = (expression) => { 
            if (!expression) return undefined; 
            const pOfMatch = expression.match(/(\d+(?:\.\d+)?)%\s*of\s*(\d+(?:\.\d+)?)/i); 
            if (pOfMatch) { const [, perc, num] = pOfMatch; return (parseFloat(perc) / 100) * parseFloat(num); } 
            const convMatch = expression.match(/(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\s*to\s*([a-zA-Z]+)$/); 
            if (convMatch) { const [, v, from, to] = convMatch.map(s => s.toLowerCase()); if (conversionRates[from]?.[to]) return parseFloat(v) * conversionRates[from][to]; return `Error: Unsupported conversion.`; } 
            expression = expression.replace(/(\d+(?:\.\d+)?)\s*([+\-*/])\s*(\d+(?:\.\d+)?)%/g, (m, b, op, p) => (op === '+' || op === '-') ? `${b} ${op} (${b} * ${parseFloat(p) / 100})` : `${b} ${op} ${parseFloat(p) / 100}`); 
            expression = expression.replace(/\^/g, '**');
            try { const result = new Function(`return ${expression}`)(); return (typeof result === 'number' && !isNaN(result)) ? result : undefined; } catch { return undefined; } 
        };
        const replaceVariables = (expr) => Object.keys(variables).sort((a, b) => b.length - a.length).reduce((e, key) => e.replace(new RegExp(`\\b${key}\\b`, 'gi'), variables[key]), expr);
        
        const evaluateLine = (line, lineNumber) => {
            const commentIndex = line.indexOf('//');
            let code = (commentIndex !== -1) ? line.substring(0, commentIndex) : line;
            code = code.trim();

            if (!code || code.startsWith('for') || ['endfor', 'hiddenblock', 'hiddenend'].includes(code.toLowerCase())) return null;
            const assignMatch = code.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);
            if (assignMatch) {
                const [, varName, expr] = assignMatch;
                const result = calculate(replaceVariables(expr.trim()));
                variables[varName.toLowerCase()] = result;
                
                const commentText = (commentIndex !== -1) ? line.substring(commentIndex + 2).trim() : null;
                orderedVariables.set(varName.toLowerCase(), { value: result, comment: commentText, line: lineNumber });

                return result;
            }
            const dateMatch = code.match(/^today\s*([+\-])\s*([a-zA-Z_]\w*|\d+)\s*(days?|weeks?|months?|years?)$/i);
            if (dateMatch) {
                const [, op, val, unit] = dateMatch;
                const num = isNaN(val) ? parseInt(variables[val.toLowerCase()], 10) : parseInt(val, 10);
                if (isNaN(num)) return `Error: Invalid number.`;
                const today = new Date();
                const mult = op === '+' ? 1 : -1;
                const u = unit.toLowerCase();
                if (u.startsWith('day')) today.setDate(today.getDate() + num * mult);
                else if (u.startsWith('week')) today.setDate(today.getDate() + num * 7 * mult);
                else if (u.startsWith('month')) today.setMonth(today.getMonth() + num * mult);
                else if (u.startsWith('year')) today.setFullYear(today.getFullYear() + num * mult);
                return today.toDateString();
            }
            return calculate(replaceVariables(code));
        };
        const formatResult = (r) => { if (typeof r === 'number' && roundingToggle.checked && !Number.isInteger(r)) return r.toFixed(2); return (r === undefined || r === null) ? '' : r; };

        // --- Syntax Highlighting Logic ---
        const highlightText = (line, definedVars) => { const escapeHtml = (t) => t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); const cIdx = line.indexOf('//'); const code = cIdx !== -1 ? line.substring(0, cIdx) : line; const comment = cIdx !== -1 ? `<span class="comment">${escapeHtml(line.substring(cIdx))}</span>` : ''; const varNameOnLine = (code.trim().match(/^([a-zA-Z_]\w*)\s*=/) || [])[1]?.toLowerCase(); const tokens = code.split(/(\b[a-zA-Z_]\w*\b|=|\s+|\^)/).filter(Boolean); const processed = tokens.map(t => { const trimmed = t.trim().toLowerCase(); if (!t.trim()) return t; if (t === '=' || t === '^') return `<span class="operator">${t}</span>`; if (specialWords[trimmed]) return `<span class="${specialWords[trimmed]}">${escapeHtml(t)}</span>`; if (trimmed === varNameOnLine) return `<span class="${definedVars.has(trimmed) ? 'variable-redefined' : 'variable-new'}">${escapeHtml(t)}</span>`; if (definedVars.has(trimmed)) return `<span class="variable-used">${escapeHtml(t)}</span>`; return escapeHtml(t); }).join(''); return processed + comment; };

        // --- Main Processing Function ---
        const processAndHighlight = () => {
            const text = inputArea.value;
            const lines = text.split('\n');
            const isCleanView = cleanViewToggle.checked;

            const definedVarsForHighlight = new Set();
            const highlightedHTML = lines.map((line, index) => {
                const highlightedLine = highlightText(line, definedVarsForHighlight);
                const varNameMatch = line.trim().match(/^([a-zA-Z_]\w*)\s*=/);
                if (varNameMatch) { definedVarsForHighlight.add(varNameMatch[1].toLowerCase()); }
                return `<div data-line-id="${index}">${highlightedLine || '<br>'}</div>`;
            }).join('');
            highlightingArea.innerHTML = highlightedHTML;

            variables = {}; 
            orderedVariables = new Map();
            let outputHTML = ''; 
            let loopIdCounter = 0;
            let isHiddenBlockActive = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                const lowerTrimmedLine = trimmedLine.toLowerCase();

                if (lowerTrimmedLine === 'hiddenblock') {
                    isHiddenBlockActive = true;
                    if (!isCleanView) {
                         outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1 break-all">${highlightText(line, new Set(Object.keys(variables)))}</span></div>`;
                    }
                    continue;
                }
                if (lowerTrimmedLine === 'hiddenend') {
                    isHiddenBlockActive = false;
                     if (!isCleanView) {
                        outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1 break-all">${highlightText(line, new Set(Object.keys(variables)))}</span></div>`;
                    }
                    continue;
                }

                const forLoopMatch = trimmedLine.match(/^for\s+([a-zA-Z_]\w*)\s*=\s*(.*?)\s+to\s+(.*?)\s*$/i);

                if (forLoopMatch) {
                    let endforIndex = -1; let nestingLevel = 0;
                    for (let j = i + 1; j < lines.length; j++) { if (lines[j].trim().match(/^for\s/i)) nestingLevel++; if (lines[j].trim().toLowerCase() === 'endfor') { if (nestingLevel === 0) { endforIndex = j; break; } else { nestingLevel--; } } }
                    if (endforIndex === -1) { if (!isCleanView && !isHiddenBlockActive) { outputHTML += `<div class="text-red-400 output-line" data-line-id="${i}">Error: Missing 'endfor'.</div>`; } continue; }

                    const [, iterator, startExpr, endExpr] = forLoopMatch; const iteratorLower = iterator.toLowerCase();
                    const startValue = Math.round(calculate(replaceVariables(startExpr.trim())));
                    const endValue = Math.round(calculate(replaceVariables(endExpr.trim())));
                    
                    if (!isCleanView) {
                        loopIdCounter++; const loopBodyId = `loop-body-${loopIdCounter}`;
                        const highlightedHeader = highlightText(line, new Set(Object.keys(variables)));
                        outputHTML += `<div class="loop-header output-line" data-line-id="${i}" data-target-id="${loopBodyId}"><span class="toggle-icon">►</span><div class="flex items-start output-highlight flex-1"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedHeader}</span></div></div>`;
                        let loopBodyHTML = '';
                        if (isNaN(startValue) || isNaN(endValue)) { loopBodyHTML = `<div class="text-red-400 ml-8">Error: Loop bounds must be numbers.</div>`; } 
                        else {
                            const loopBodyLines = lines.slice(i + 1, endforIndex);
                            for (let k = startValue; k <= endValue; k++) {
                                variables[iteratorLower] = k;
                                loopBodyLines.forEach((bodyLine, bodyLineIndex) => {
                                    const originalLineId = i + 1 + bodyLineIndex;
                                    const result = evaluateLine(bodyLine, originalLineId);
                                    const highlightedBodyLine = highlightText(bodyLine, new Set(Object.keys(variables)));
                                    if (result !== null && result !== undefined) { loopBodyHTML += `<div class="flex items-start output-highlight ml-8 output-line" data-line-id="${originalLineId}"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1 break-all">${highlightedBodyLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`; } 
                                    else if (bodyLine.trim()) { loopBodyHTML += `<div class="flex items-start output-highlight ml-8 output-line" data-line-id="${originalLineId}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1 break-all">${highlightedBodyLine}</span></div>`; } 
                                    else { loopBodyHTML += `<div class="h-6 ml-8 output-line" data-line-id="${originalLineId}"></div>`; }
                                });
                            }
                        }
                        delete variables[iteratorLower];
                        loopBodyHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${endforIndex}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightText(lines[endforIndex], new Set(Object.keys(variables)))}</span></div>`;
                        outputHTML += `<div id="${loopBodyId}" class="loop-body hidden">${loopBodyHTML}</div>`;
                    } else {
                        if (!isNaN(startValue) && !isNaN(endValue)) {
                            const loopBodyLines = lines.slice(i + 1, endforIndex);
                            for (let k = startValue; k <= endValue; k++) {
                                variables[iteratorLower] = k;
                                loopBodyLines.forEach((bodyLine, bodyLineIndex) => { evaluateLine(bodyLine, i + 1 + bodyLineIndex); });
                            }
                        }
                        delete variables[iteratorLower];
                    }
                    i = endforIndex;
                } else if (lowerTrimmedLine === 'endfor') {
                    if (!isCleanView && !isHiddenBlockActive) outputHTML += `<div class="text-red-400 output-line" data-line-id="${i}">Error: Unexpected 'endfor'.</div>`;
                } else {
                    const lineVars = new Set(Object.keys(variables));
                    const result = evaluateLine(line, i);
                    
                    if (isCleanView) {
                        if (isHiddenBlockActive) continue;

                        const commentIndex = line.indexOf('//');
                        const codePart = (commentIndex !== -1) ? line.substring(0, commentIndex) : line;
                        const trimmedCode = codePart.trim();
                        const rawCommentText = (commentIndex !== -1) ? line.substring(commentIndex + 2).trim() : null;
                        const commentText = interpolateComment(rawCommentText, variables);
                        const assignmentMatch = trimmedCode.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);

                        let lineHTML = '';
                        if (assignmentMatch) {
                            const varName = assignmentMatch[1];
                            const varClass = lineVars.has(varName.toLowerCase()) ? 'variable-redefined' : 'variable-new';
                            const resultPart = `<span><span class="${varClass}">${varName}</span><span class="operator"> = </span><span class="text-green-400 font-bold">${formatResult(result)}</span></span>`;
                            const commentPart = commentText ? `<span class="text-yellow-400 italic text-right pl-4">${commentText}</span>` : '';
                            lineHTML = `<div class="flex justify-between items-start output-highlight output-line py-1" data-line-id="${i}">${resultPart}${commentPart}</div>`;
                        } else if (trimmedCode && result !== null && result !== undefined) {
                            const resultPart = `<span class="text-gray-400">= </span><span class="text-green-400">${formatResult(result)}</span>`;
                            const commentPart = commentText ? `<span class="text-yellow-400 italic pl-4">${commentText}</span>` : '';
                            lineHTML = `<div class="flex justify-end items-start output-highlight output-line py-1" data-line-id="${i}"><span>${resultPart}${commentPart}</span></div>`;
                        } else if (commentText && !trimmedCode) {
                            lineHTML = `<div class="text-yellow-400 italic py-1 output-line" data-line-id="${i}">${commentText}</div>`;
                        } else if (trimmedCode) {
                            lineHTML = `<div class="py-1 output-line" data-line-id="${i}">${highlightText(line, lineVars)}</div>`;
                        } else if (!trimmedLine) {
                            lineHTML = `<div class="h-6 output-line" data-line-id="${i}"></div>`;
                        }
                        outputHTML += lineHTML;
                    } else {
                        if (!trimmedLine) { outputHTML += `<div class="h-6 output-line" data-line-id="${i}"></div>`; } 
                        else {
                            const highlightedLine = highlightText(line, lineVars);
                            if (result !== null && result !== undefined) { outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1 break-all">${highlightedLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`; } 
                            else { outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1 break-all">${highlightedLine}</span></div>`; }
                        }
                    }
                }
            }
            outputArea.innerHTML = outputHTML || '<div class="text-gray-400">Your results will appear here in real-time.</div>';
        };

        // --- Autocomplete Logic ---
        const getAutocompleteKeywords = (textContent) => { const orderedVars = []; textContent.split('\n').forEach(line => { const match = line.trim().match(/^([a-zA-Z_]\w*)\s*=/); if (match) { const varName = match[1].toLowerCase(); const existingIndex = orderedVars.indexOf(varName); if (existingIndex > -1) orderedVars.splice(existingIndex, 1); orderedVars.push(varName); } }); const newestVarsFirst = orderedVars.reverse(); const specialKeywordsList = Object.keys(specialWords); return [...newestVarsFirst, ...specialKeywordsList.filter(k => !orderedVars.includes(k))]; };
        
        function updateAutocompletePopup() {
            if (!autocompleteState.active || autocompleteState.suggestions.length === 0) { return autocompletePopup.classList.add('hidden'); }
            autocompletePopup.innerHTML = autocompleteState.suggestions.map((s, i) => `<div class="autocomplete-item ${i === autocompleteState.selectedIndex ? 'selected' : ''}" data-index="${i}">${s}</div>`).join('');
            const mirror = $('#autocomplete-mirror'); const text = inputArea.value; const cursorPos = inputArea.selectionStart;
            mirror.style.width = `${inputArea.clientWidth}px`; mirror.scrollTop = inputArea.scrollTop;
            const textBeforeCursor = text.substring(0, cursorPos); mirror.textContent = textBeforeCursor;
            const marker = document.createElement('span'); marker.innerHTML = '&nbsp;'; mirror.appendChild(marker);
            const lineHeight = parseFloat(getComputedStyle(inputArea).lineHeight);
            let left = marker.offsetLeft; let top = marker.offsetTop - inputArea.scrollTop + lineHeight;
            mirror.textContent = '';
            const inputContainerRect = inputArea.parentElement.getBoundingClientRect();
            autocompletePopup.style.left = `${left}px`; autocompletePopup.style.top = `${top}px`;
            if (top + autocompletePopup.offsetHeight > inputContainerRect.height) { autocompletePopup.style.top = `${top - lineHeight - autocompletePopup.offsetHeight - 5}px`; }
            autocompletePopup.classList.remove('hidden');
        }

        function closeAutocomplete() { autocompleteState.active = false; autocompletePopup.classList.add('hidden'); }
        function handleAutocomplete() { const text = inputArea.value; const cursorPos = inputArea.selectionStart; const textBeforeCursor = text.substring(0, cursorPos); if (/\s$/.test(textBeforeCursor) || textBeforeCursor.length === 0) return closeAutocomplete(); const wordMatch = textBeforeCursor.match(/(\w+)$/); if (!wordMatch) return closeAutocomplete(); autocompleteState.currentWord = wordMatch[1]; const lowerCurrentWord = autocompleteState.currentWord.toLowerCase(); autocompleteState.wordStartIndex = cursorPos - autocompleteState.currentWord.length; const suggestions = getAutocompleteKeywords(text).filter(kw => kw.toLowerCase().startsWith(lowerCurrentWord) && kw.toLowerCase() !== lowerCurrentWord); if (suggestions.length > 0) { autocompleteState.active = true; autocompleteState.suggestions = suggestions; autocompleteState.selectedIndex = 0; } else { closeAutocomplete(); } updateAutocompletePopup(); }
        
        function acceptSuggestion(suggestion) {
            const { value, selectionStart } = inputArea;
            const { wordStartIndex } = autocompleteState;
            const textBefore = value.substring(0, wordStartIndex);
            const textAfter = value.substring(selectionStart);
            const newText = `${textBefore}${suggestion}${textAfter}`;
            inputArea.value = newText;
            const newCursorPos = wordStartIndex + suggestion.length;
            inputArea.selectionStart = newCursorPos;
            inputArea.selectionEnd = newCursorPos;
            closeAutocomplete();
            inputArea.focus();
            inputArea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // --- Event Listeners ---
        inputArea.addEventListener('input', () => { processAndHighlight(); handleAutocomplete(); });
        inputArea.addEventListener('scroll', () => { highlightingArea.scrollTop = inputArea.scrollTop; highlightingArea.scrollLeft = inputArea.scrollLeft; });
        roundingToggle.addEventListener('change', processAndHighlight);
        cleanViewToggle.addEventListener('change', processAndHighlight);
        inputArea.addEventListener('keydown', (event) => { if (autocompleteState.active) { if (['ArrowDown', 'ArrowUp', 'Escape', 'Enter', 'Tab'].includes(event.key)) { event.preventDefault(); if (event.key === 'ArrowDown') { autocompleteState.selectedIndex = (autocompleteState.selectedIndex + 1) % autocompleteState.suggestions.length; updateAutocompletePopup(); } else if (event.key === 'ArrowUp') { autocompleteState.selectedIndex = (autocompleteState.selectedIndex - 1 + autocompleteState.suggestions.length) % autocompleteState.suggestions.length; updateAutocompletePopup(); } else if (event.key === 'Escape') { closeAutocomplete(); } else if (event.key === 'Enter' || event.key === 'Tab') { acceptSuggestion(autocompleteState.suggestions[autocompleteState.selectedIndex]); } return; } } });
        document.addEventListener('click', (e) => !autocompletePopup.contains(e.target) && closeAutocomplete());
        autocompletePopup.addEventListener('click', (e) => { const item = e.target.closest('.autocomplete-item'); if(item) acceptSuggestion(autocompleteState.suggestions[parseInt(item.dataset.index)]); });
        eraseButton.addEventListener('click', () => { inputArea.value = ''; processAndHighlight(); setDefaultCalculationName(); showMessage('Calculator cleared!'); });
        
        outputArea.addEventListener('click', (e) => {
            const header = e.target.closest('.loop-header');
            if (header) {
                const targetId = header.dataset.targetId;
                const body = $(`#${targetId}`);
                const icon = header.querySelector('.toggle-icon');
                if (body) { body.classList.toggle('hidden'); icon.classList.toggle('expanded'); icon.innerHTML = icon.classList.contains('expanded') ? '▼' : '►'; }
                return;
            }
            const targetLine = e.target.closest('.output-line');
            if (targetLine && targetLine.dataset.lineId) {
                scrollToLine(parseInt(targetLine.dataset.lineId, 10));
            }
        });

        toggleControlsButton.addEventListener('click', () => { controlsPanel.classList.toggle('hidden'); });

        // --- SECURITY & CLOUD LOGIC ---

        async function fetchCloudSlotMetadata() {
            const { data, error } = await supabase.from('slots').select('id, name');
            if (data) {
                cloudSlotMetadata = {};
                data.forEach(row => {
                    cloudSlotMetadata[row.id] = row.name;
                });
                updateCloudButtons();
            }
        }

        function updateCloudButtons() {
            for (let i = 1; i <= 6; i++) {
                const slotTextElement = $(`#slot-text-${i}`);
                const slotName = cloudSlotMetadata[i];

                if (isCloudUnlocked) {
                    if (slotName) {
                        slotTextElement.textContent = slotName;
                        slotTextElement.classList.replace('text-gray-500', 'text-gray-200');
                    } else {
                        slotTextElement.textContent = `Empty`;
                        slotTextElement.classList.replace('text-gray-200', 'text-gray-500');
                    }
                }
            }
        }

        function unlockCloudUI() {
            isCloudUnlocked = true;
            cloudStatusBadge.innerHTML = `<span class="text-green-400">●</span> Unlocked`;
            cloudStatusBadge.classList.replace('text-gray-400', 'text-green-400');
            cloudStatusBadge.classList.replace('border-gray-500', 'border-green-600');
            
            for (let i = 1; i <= 6; i++) {
                const saveBtn = $(`#save-${i}`);
                const loadBtn = $(`#load-${i}`);
                const slotRow = $(`#slot-row-${i}`);
                const midDiv = $(`#slot-mid-${i}`);
                const slotText = $(`#slot-text-${i}`);

                // Update Row Style to base unlocked state
                slotRow.classList.replace('bg-gray-700/50', 'bg-gray-700');
                
                // Set Buttons to transparent (visuals handled by hover)
                saveBtn.className = 'px-4 bg-transparent text-gray-300 font-medium text-sm transition-colors duration-200 border-r border-gray-600 focus:outline-none z-10';
                loadBtn.className = 'px-4 bg-transparent text-gray-300 font-medium text-sm transition-colors duration-200 border-l border-gray-600 focus:outline-none z-10';
                
                // --- HOVER LOGIC FOR SAVE ---
                // When hovering Save, turn Save + Middle GREEN
                saveBtn.onmouseenter = () => {
                    saveBtn.classList.add('bg-green-600', 'text-white');
                    midDiv.classList.add('bg-green-600');
                    slotText.classList.remove('text-gray-200', 'text-gray-500');
                    slotText.classList.add('text-white');
                };
                saveBtn.onmouseleave = () => {
                    saveBtn.classList.remove('bg-green-600', 'text-white');
                    midDiv.classList.remove('bg-green-600');
                    slotText.classList.remove('text-white');
                    updateCloudButtons(); // Restore correct text color
                };

                // --- HOVER LOGIC FOR LOAD ---
                // When hovering Load, turn Load + Middle BLUE
                loadBtn.onmouseenter = () => {
                    loadBtn.classList.add('bg-blue-600', 'text-white');
                    midDiv.classList.add('bg-blue-600');
                    slotText.classList.remove('text-gray-200', 'text-gray-500');
                    slotText.classList.add('text-white');
                };
                loadBtn.onmouseleave = () => {
                    loadBtn.classList.remove('bg-blue-600', 'text-white');
                    midDiv.classList.remove('bg-blue-600');
                    slotText.classList.remove('text-white');
                    updateCloudButtons(); // Restore correct text color
                };

                // Update text placeholder
                if (slotText.textContent === "Locked") {
                     slotText.textContent = "Empty";
                }
            }

            // Fetch real names from DB
            fetchCloudSlotMetadata();

            passwordModal.classList.add('hidden');
            
            // Resume pending action if any
            if (pendingCloudAction) {
                if (pendingCloudAction.type === 'save') initiateSave(pendingCloudAction.slotId);
                else if (pendingCloudAction.type === 'load') loadFromCloudSlot(pendingCloudAction.slotId);
                pendingCloudAction = null;
            }
        }

        async function verifyPassword(pwd) {
            passwordError.classList.add('hidden');
            const { data, error } = await supabase.rpc('verify_cloud_password', { input_pass: pwd });
            
            if (error) {
                console.error('RPC Error:', error);
                passwordError.textContent = "Server verification failed. Did you run the SQL setup?";
                passwordError.classList.remove('hidden');
                return;
            }

            if (data === true) {
                unlockCloudUI();
                passwordInput.value = '';
                showMessage("Security check passed. Cloud features unlocked.");
            } else {
                passwordError.textContent = "Incorrect password.";
                passwordError.classList.remove('hidden');
            }
        }

        function requestCloudAccess(type, slotId) {
            if (isCloudUnlocked) {
                if (type === 'save') initiateSave(slotId);
                else loadFromCloudSlot(slotId);
            } else {
                pendingCloudAction = { type, slotId };
                passwordModal.classList.remove('hidden');
                passwordModal.classList.add('flex');
                passwordInput.focus();
            }
        }

        // Logic to trigger confirmation modal before saving
        function initiateSave(slotId) {
            const currentSlotName = cloudSlotMetadata[slotId];
            const newName = calculationNameInput.value.trim() || 'Untitled';
            
            $('#confirm-title').textContent = 'Confirm Cloud Save';
            if (currentSlotName) {
                $('#confirm-text').innerHTML = `Slot ${slotId} currently contains <strong>"${currentSlotName}"</strong>.<br>Do you want to overwrite it with <strong>"${newName}"</strong>?`;
            } else {
                $('#confirm-text').innerHTML = `Save <strong>"${newName}"</strong> to Slot ${slotId}?`;
            }
            
            $('#confirm-ok').className = 'bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700';
            $('#confirm-ok').textContent = 'Yes, Save';
            
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            
            // Override the OK click handler for this specific action
            $('#confirm-ok').onclick = () => {
                confirmModal.classList.add('hidden');
                performCloudSave(slotId);
            };
            $('#confirm-cancel').onclick = () => {
                 confirmModal.classList.add('hidden');
            };
        }

        // The actual save function
        async function performCloudSave(slotId) {
            const content = inputArea.value;
            const name = calculationNameInput.value.trim() || 'Untitled Calculation';
            
            if (!content) { showMessage('Nothing to save!'); return; }
            showMessage(`Saving to Cloud Slot ${slotId}...`);
            
            const { data, error } = await supabase.from('slots').upsert({ id: slotId, name: name, content: content });

            if (error) { showMessage(`Error: ${error.message}`); } 
            else { 
                showMessage(`Saved to Cloud Slot ${slotId}!`);
                fetchCloudSlotMetadata(); // Refresh button names
            }
        }

        // Helper function to handle loading
        async function loadFromCloudSlot(slotId) {
            const currentSlotName = cloudSlotMetadata[slotId];
            if (!currentSlotName && isCloudUnlocked) {
                showMessage(`Slot ${slotId} is empty.`);
                return;
            }

            showMessage(`Loading Cloud Slot ${slotId}...`);
            const { data, error } = await supabase.from('slots').select('*').eq('id', slotId).single();

            if (error) {
                if (error.code === 'PGRST116') showMessage(`Slot ${slotId} is empty.`);
                else showMessage(`Error: ${error.message}`);
            } else if (data) {
                inputArea.value = data.content || '';
                calculationNameInput.value = data.name || 'Untitled';
                processAndHighlight();
                showMessage(`Loaded "${data.name}"!`);
            }
        }

        // Attach listeners to buttons 1 through 6
        for (let i = 1; i <= 6; i++) {
            $(`#save-${i}`).addEventListener('click', () => requestCloudAccess('save', i));
            $(`#load-${i}`).addEventListener('click', () => requestCloudAccess('load', i));
        }

        passwordSubmit.addEventListener('click', () => verifyPassword(passwordInput.value));
        passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyPassword(passwordInput.value); });
        passwordCancel.addEventListener('click', () => { passwordModal.classList.add('hidden'); pendingCloudAction = null; });

        // --- End Security & Cloud Logic ---

        saveToFileButton.addEventListener('click', () => { const data = { name: calculationNameInput.value, content: inputArea.value }; if (!data.content.trim()) { showMessage('Nothing to save!'); return; } const sanitized = (calculationNameInput.value.trim() || 'Calculation').replace(/[\/\\?%*:|"<>]/g, '').replace(/\s+/g, '_'); const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `IC_${sanitized}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showMessage('File download started!'); });
        loadFromFileButton.addEventListener('click', () => { fileLoaderInput.click(); });
        fileLoaderInput.addEventListener('change', (event) => { if (!event.target.files.length) return; const file = event.target.files[0]; const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; try { const data = JSON.parse(content); if (data?.content !== undefined) { calculationNameInput.value = data.name || 'Insta-Clone'; inputArea.value = data.content; } else { throw new Error("Not our format"); } } catch (err) { inputArea.value = content; calculationNameInput.value = file.name.replace(/\.[^/.]+$/, ""); } processAndHighlight(); showMessage(`File "${file.name}" loaded!`); }; reader.onerror = () => showMessage(`Error reading file.`); reader.readAsText(file); event.target.value = null; });
        shareButton.addEventListener('click', () => { const data = { name: calculationNameInput.value, content: inputArea.value }; if (!data.content.trim()) { showMessage('Nothing to share!'); return; } try { const compressed = pako.deflate(JSON.stringify(data)); let bin = ''; for (let i = 0; i < compressed.length; i++) bin += String.fromCharCode(compressed[i]); const url = `${location.origin}${location.pathname}?data=${encodeURIComponent(btoa(bin))}`; navigator.clipboard.writeText(url).then(() => showMessage('Share link copied!'), () => showMessage('Failed to copy.')); } catch (e) { showMessage('Could not create share link.'); } });
        noSleepToggle.addEventListener('change', async (e) => { if (e.target.checked) { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', () => { if(e.target.checked) { e.target.checked = false; showMessage('Wake lock released.'); }}); showMessage('Screen wake lock active.'); } catch (err) { showMessage(`Error: ${err.message}`); e.target.checked = false; } } else { showMessage('Wake Lock API not supported.'); e.target.checked = false; } } else if (wakeLock) { wakeLock.release(); wakeLock = null; } });
        
        helpButton.addEventListener('click', () => { helpModal.classList.remove('hidden'); helpModal.classList.add('flex'); });
        helpCloseButton.addEventListener('click', () => { helpModal.classList.add('hidden'); helpModal.classList.remove('flex'); });

        // --- Variables Modal Logic ---
        const isValidVariableName = (name) => /^[a-zA-Z_]\w*$/.test(name) && !specialWords.hasOwnProperty(name.toLowerCase());

        const renameVariableInCode = (oldName, newName) => {
            const lowerNewName = newName.toLowerCase();
            const lowerOldName = oldName.toLowerCase();

            if (!isValidVariableName(newName)) {
                showMessage(`"${newName}" is not a valid variable name.`);
                return;
            }
            if (lowerNewName === lowerOldName) return;

            const performRename = () => {
                const codeRegex = new RegExp(`\\b${oldName}\\b`, 'gi');
                const commentRegex = new RegExp(`\\{${oldName}\\}`, 'gi'); 
                
                const lines = inputArea.value.split('\n');
                const newLines = lines.map(line => {
                    const commentIndex = line.indexOf('//');
                    if (commentIndex === -1) {
                        return line.replace(codeRegex, newName);
                    } else {
                        const codePart = line.substring(0, commentIndex);
                        const commentPart = line.substring(commentIndex);
                        const updatedCodePart = codePart.replace(codeRegex, newName);
                        const updatedCommentPart = commentPart.replace(commentRegex, `{${newName}}`);
                        return updatedCodePart + updatedCommentPart;
                    }
                });

                inputArea.value = newLines.join('\n');
                processAndHighlight();
                populateVariablesModal();
                showMessage(`Renamed "${oldName}" to "${newName}".`);
                if (confirmModal.classList.contains('flex')) { confirmModal.classList.add('hidden'); }
            };

            if (variables.hasOwnProperty(lowerNewName)) {
                $('#confirm-title').textContent = 'Merge Variables?';
                $('#confirm-text').textContent = `A variable named "${newName}" already exists. Do you want to merge these? This cannot be undone.`;
                $('#confirm-ok').className = 'bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-yellow-700';
                confirmModal.classList.add('flex');
                confirmModal.classList.remove('hidden');
                $('#confirm-ok').onclick = performRename;
                $('#confirm-cancel').onclick = () => { confirmModal.classList.add('hidden'); populateVariablesModal(); };
            } else {
                performRename();
            }
        };

        const populateVariablesModal = () => {
            if (orderedVariables.size === 0) { variablesContent.innerHTML = `<div class="text-gray-400">No variables have been defined yet.</div>`; return; }
            let contentHTML = '<div class="grid grid-cols-[1fr,auto,1fr,2fr] gap-x-4 items-center border-b border-gray-600 pb-2 mb-2 text-sm text-gray-400"><h5>Variable</h5><div></div><h5 class="text-center">Final Value</h5><h5 class="text-right">Comment</h5></div>';
            for (const [name, data] of orderedVariables.entries()) {
                const formattedValue = formatResult(data.value);
                const commentText = data.comment ? `// ${data.comment}` : '';
                contentHTML += `
                    <div class="variable-row grid grid-cols-[1fr,auto,1fr,2fr] gap-x-4 items-start py-1 border-b border-gray-700/50" data-line-index="${data.line}" data-var-name="${name}">
                        <span class="variable-name-cell variable-new font-bold break-all flex items-center">${name}</span>
                        <button class="rename-btn" data-var-name="${name}" title="Rename variable">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <span class="text-center text-green-400 break-all">${formattedValue}</span>
                        <span class="text-right text-yellow-400 italic text-sm break-all">${commentText}</span>
                    </div>
                `;
            }
            variablesContent.innerHTML = contentHTML;
        };

        variablesButton.addEventListener('click', () => { populateVariablesModal(); variablesModal.classList.remove('hidden'); variablesModal.classList.add('flex'); });
        variablesCloseButton.addEventListener('click', () => { variablesModal.classList.add('hidden'); variablesModal.classList.remove('flex'); });

        variablesContent.addEventListener('click', (e) => {
            const renameBtn = e.target.closest('.rename-btn');
            if (renameBtn) {
                e.stopPropagation();
                const oldName = renameBtn.dataset.varName;
                const nameCell = renameBtn.previousElementSibling;
                if (nameCell.querySelector('input')) return;
                document.querySelectorAll('.variable-rename-input').forEach(inp => { const originalName = inp.parentElement.parentElement.dataset.varName; inp.parentElement.innerHTML = originalName; });
                nameCell.innerHTML = `<input type="text" class="variable-rename-input" value="${oldName}" />`;
                const input = nameCell.querySelector('input');
                input.focus(); input.select();
                const handleFinish = (shouldRename) => { const newName = input.value.trim(); if (shouldRename && newName) { renameVariableInCode(oldName, newName); } else { populateVariablesModal(); } };
                input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); handleFinish(true); } else if (ev.key === 'Escape') { handleFinish(false); } });
                input.addEventListener('blur', () => { setTimeout(() => { if (document.body.contains(input)) { handleFinish(false); } }, 100); }, { once: true });
                return;
            }
            const row = e.target.closest('.variable-row');
            if (row && !row.querySelector('input')) { const lineIndex = parseInt(row.dataset.lineIndex, 10); variablesModal.classList.add('hidden'); variablesModal.classList.remove('flex'); setTimeout(() => { scrollToLine(lineIndex); }, 0); }
        });

        // --- Line Highlighting Logic ---
        const clearHighlights = () => { document.querySelectorAll('.line-highlight').forEach(el => el.classList.remove('line-highlight')); };
        outputArea.addEventListener('mouseover', (e) => { const targetLine = e.target.closest('.output-line'); if (targetLine) { clearHighlights(); const lineId = targetLine.dataset.lineId; if (lineId) { const inputLine = $(`#highlightingArea [data-line-id="${lineId}"]`); if (inputLine) { inputLine.classList.add('line-highlight'); targetLine.classList.add('line-highlight'); } } } });
        outputArea.addEventListener('mouseout', () => { clearHighlights(); });

        // --- Initial Page Load ---
        window.addEventListener('DOMContentLoaded', () => {
            helpContent.innerHTML = HELP_CONTENT_POPUP_HTML.replace(/\\n/g, '\n');
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            let loadedFromUrl = false;
            if (sharedData) {
                try {
                    let binaryString = atob(decodeURIComponent(sharedData));
                    const uint8array = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) uint8array[i] = binaryString.charCodeAt(i);
                    const data = JSON.parse(pako.inflate(uint8array, { to: 'string' }));
                    if (data?.content !== undefined) {
                        calculationNameInput.value = data.name || 'Insta-Clone';
                        inputArea.value = data.content;
                        loadedFromUrl = true;
                        showMessage('Loaded shared calculation!');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { showMessage('Could not load data from link.'); }
            }
            if (!loadedFromUrl) {
                inputArea.value = HELP_CONTENT_INPUT;
                setDefaultCalculationName(); 
            }
            processAndHighlight();
        });
    </script>
</body>
</html>
