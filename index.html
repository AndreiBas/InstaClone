<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta-Clone Calculator</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
        /* Style for the textarea to match the output area */
        #inputArea {
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
            outline: none;
            resize: none;
            line-height: 1.5;
            padding: 1.5rem;
            color: #d1d5db; /* Light gray text */
            background-color: #111827; /* Dark background */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[80vh]">
        <!-- Left Panel: Input Area -->
        <div class="flex-1 flex flex-col p-6 md:p-8">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-3xl font-bold text-white">Insta-Clone</h1>
                <button id="eraseButton" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Erase</button>
            </div>
            
            <div class="relative flex-1">
                <textarea
                    id="inputArea"
                    class="w-full h-full rounded-xl bg-gray-900 text-gray-200 font-mono text-lg transition-all duration-300 focus:ring-4 focus:ring-blue-500/50"
                    placeholder="2500 * 50
tax_rate = 0.15
total = (2500 * 50) + (2500 * 50 * tax_rate)
total"
                ></textarea>
            </div>
        </div>
        <!-- Right Panel: Output Area -->
        <div class="flex-1 flex flex-col p-6 md:p-8 border-t-2 md:border-t-0 md:border-l-2 border-gray-700 bg-gray-700/30">
            <h2 class="text-2xl font-bold text-white mb-6">Results</h2>
            <div id="outputArea" class="relative flex-1 bg-gray-900 rounded-xl p-6 overflow-y-auto text-gray-200 font-mono text-lg leading-relaxed">
                <div class="text-gray-400">Your results will appear here in real-time.</div>
            </div>
        </div>
    </div>

    <!-- Saved Calculations Section, now at the very bottom -->
    <div class="w-full max-w-4xl mt-8 p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <h3 class="text-lg font-semibold text-white mb-2">Saved Calculations (3 slots)</h3>
        <div id="save-buttons" class="grid grid-cols-3 gap-2">
            <button id="save-1" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Save 1</button>
            <button id="save-2" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Save 2</button>
            <button id="save-3" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Save 3</button>
        </div>
        <div id="load-buttons" class="grid grid-cols-3 gap-2 mt-2">
            <button id="load-1" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">Load 1</button>
            <button id="load-2" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">Load 2</button>
            <button id="load-3" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">Load 3</button>
        </div>
    </div>

    <!-- Confirmation Modal (hidden by default) -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 rounded-xl p-6 w-96 shadow-2xl border border-gray-700">
            <h4 class="text-xl font-bold mb-4">Overwrite Calculation?</h4>
            <p id="confirm-message" class="text-gray-400 mb-6">This slot already has a saved calculation. Do you want to replace it?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel" class="bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>

    <!-- Message Box (hidden by default) -->
    <div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-lg shadow-lg z-50 hidden opacity-0 transition-opacity duration-300">
        <p id="message-text"></p>
    </div>

    <script>
        // --- Core Application Logic ---
        
        // DOM element references
        const inputArea = document.getElementById('inputArea');
        const outputArea = document.getElementById('outputArea');
        const eraseButton = document.getElementById('eraseButton');

        // References for the new save/load functionality
        const saveButtons = document.querySelectorAll('#save-buttons button');
        const loadButtons = document.querySelectorAll('#load-buttons button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Global object to store user-defined variables
        let variables = {};
        
        // Hardcoded conversion rates for demonstration purposes
        const conversionRates = {
            usd: { eur: 0.92, gbp: 0.78 },
            eur: { usd: 1.09, gbp: 0.85 },
            gbp: { usd: 1.28, eur: 1.17 },
            
            // Length units
            m: { ft: 3.28084, cm: 100 },
            ft: { m: 0.3048, cm: 30.48 },
            cm: { m: 0.01, ft: 0.0328084 },

            // Mass units
            kg: { lb: 2.20462 },
            lb: { kg: 0.453592 },
        };
        
        // --- Helper Functions ---

        /**
         * Shows a temporary message box with a given text.
         * @param {string} text The message to display.
         */
        const showMessage = (text) => {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('opacity-0');
            }, 10);
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        };

        /**
         * Parses and evaluates a single line of input.
         * @param {string} line The single line of text to evaluate.
         * @returns {string|null} The calculated result as a string, or null if the line is a variable assignment.
         */
        const evaluateLine = (line) => {
            line = line.trim();
            if (!line) return null; // Skip empty lines

            // First, check for variable assignment (e.g., `variable = value`)
            const assignmentMatch = line.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);
            if (assignmentMatch) {
                const varName = assignmentMatch[1];
                const expression = assignmentMatch[2];
                try {
                    // Replace variables in the expression before calculating
                    const sanitizedExpression = replaceVariables(expression);
                    const result = calculate(sanitizedExpression);
                    variables[varName] = result; // Store the result in the variables object
                    return null; // Return null for assignments, as there's no output to display
                } catch (e) {
                    return `Error: Invalid assignment for '${varName}'.`;
                }
            }

            // Next, check for date calculation pattern (e.g., "today + 90 days" or "today + y days")
            const dateMatch = line.match(/^today\s*([+\-])\s*([a-zA-Z_]\w*|\d+)\s*(days?|weeks?|months?|years?)$/i);
            if (dateMatch) {
                const operator = dateMatch[1];
                const valuePart = dateMatch[2];
                const unit = dateMatch[3].toLowerCase();
                let value;
                
                if (isNaN(valuePart)) {
                    // It's a variable name, look it up
                    if (variables[valuePart] !== undefined && !isNaN(variables[valuePart])) {
                        value = parseInt(variables[valuePart], 10);
                    } else {
                        return `Error: Variable '${valuePart}' is not a valid number.`;
                    }
                } else {
                    // It's a number
                    value = parseInt(valuePart, 10);
                }
                
                const today = new Date();
                
                if (operator === '+') {
                    if (unit.startsWith('day')) today.setDate(today.getDate() + value);
                    else if (unit.startsWith('week')) today.setDate(today.getDate() + (value * 7));
                    else if (unit.startsWith('month')) today.setMonth(today.getMonth() + value);
                    else if (unit.startsWith('year')) today.setFullYear(today.getFullYear() + value);
                } else if (operator === '-') {
                    if (unit.startsWith('day')) today.setDate(today.getDate() - value);
                    else if (unit.startsWith('week')) today.setDate(today.getDate() - (value * 7));
                    else if (unit.startsWith('month')) today.setMonth(today.getMonth() - value);
                    else if (unit.startsWith('year')) today.setFullYear(today.getFullYear() - value);
                }
                
                return today.toDateString();
            }

            // New: Check for time calculation pattern (e.g., "14:00 + 4 hours")
            const timeMatch = line.match(/^(\d{1,2}:\d{2})\s*([+\-])\s*(\d+)\s*(hours?|minutes?)$/i);
            if (timeMatch) {
                const timeString = timeMatch[1];
                const operator = timeMatch[2];
                const value = parseInt(timeMatch[3], 10);
                const unit = timeMatch[4].toLowerCase();

                const [hours, minutes] = timeString.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);

                if (operator === '+') {
                    if (unit.startsWith('hour')) date.setHours(date.getHours() + value);
                    else if (unit.startsWith('minute')) date.setMinutes(date.getMinutes() + value);
                } else if (operator === '-') {
                    if (unit.startsWith('hour')) date.setHours(date.getHours() - value);
                    else if (unit.startsWith('minute')) date.setMinutes(date.getMinutes() - value);
                }

                // Format the time as HH:MM
                const newHours = String(date.getHours()).padStart(2, '0');
                const newMinutes = String(date.getMinutes()).padStart(2, '0');
                return `${newHours}:${newMinutes}`;
            }

            // If it's not an assignment or a date calculation, try to evaluate it as a direct expression
            try {
                const sanitizedExpression = replaceVariables(line);
                const result = calculate(sanitizedExpression);
                if (result !== undefined) {
                    return result;
                }
            } catch (e) {
                // If it fails, it might be an invalid expression or a comment
                return null;
            }

            return null; // For lines that don't produce a result (e.g., comments)
        };
        
        /**
         * Replaces user-defined variables in an expression with their stored values.
         * @param {string} expression The mathematical expression string.
         * @returns {string} The expression with variables replaced.
         */
        const replaceVariables = (expression) => {
            // Sort keys by length in descending order to avoid issues with variable names that are substrings of others (e.g., `a` vs `area`).
            const sortedKeys = Object.keys(variables).sort((a, b) => b.length - a.length);

            let replacedExpression = expression;
            for (const key of sortedKeys) {
                // Use a regular expression with a word boundary (\b) to ensure we're replacing the full variable name
                const regex = new RegExp(`\\b${key}\\b`, 'g');
                replacedExpression = replacedExpression.replace(regex, variables[key]);
            }
            return replacedExpression;
        };

        /**
         * A safer, custom function to perform calculations, including percentages and unit conversions.
         * @param {string} expression The mathematical expression to calculate.
         * @returns {number|string|undefined} The result of the calculation.
         */
        const calculate = (expression) => {
            // Step 1: Check for unit conversion pattern
            // Regex to match "value unit to unit"
            const conversionMatch = expression.match(/^(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\s*to\s*([a-zA-Z]+)$/);
            if (conversionMatch) {
                const value = parseFloat(conversionMatch[1]);
                const fromUnit = conversionMatch[2].toLowerCase();
                const toUnit = conversionMatch[3].toLowerCase();

                // Check if the conversion is supported
                if (conversionRates[fromUnit] && conversionRates[fromUnit][toUnit]) {
                    const rate = conversionRates[fromUnit][toUnit];
                    return value * rate;
                } else {
                    return `Error: Unsupported conversion from '${fromUnit}' to '${toUnit}'.`;
                }
            }

            // Step 2: If no conversion, handle percentage calculations
            const percentageRegex = /((?:\d+(?:\.\d+)?))\s*([+\-*/])\s*((?:\d+(?:\.\d+)?))\s*%/g;
            let preprocessedExpression = expression;
            let match;

            while ((match = percentageRegex.exec(preprocessedExpression)) !== null) {
                const baseValue = parseFloat(match[1]);
                const operator = match[2];
                const percentageValue = parseFloat(match[3]);
                
                let replacement;
                if (operator === '+' || operator === '-') {
                    replacement = `${baseValue} ${operator} (${baseValue} * ${percentageValue} / 100)`;
                } else {
                    replacement = `${baseValue} ${operator} (${percentageValue} / 100)`;
                }

                preprocessedExpression =
                    preprocessedExpression.substring(0, match.index) +
                    replacement +
                    preprocessedExpression.substring(match.index + match[0].length);

                percentageRegex.lastIndex = 0;
            }

            // Step 3: Evaluate the final expression
            try {
                const result = new Function(`return ${preprocessedExpression}`)();
                if (typeof result === 'number' && !isNaN(result)) {
                    return result;
                }
                return undefined;
            } catch (error) {
                return undefined;
            }
        };

        /**
         * The main function to process all lines from the input area.
         */
        const processInput = () => {
            variables = {};
            const lines = inputArea.value.split('\n');
            let outputHTML = '';

            lines.forEach((line) => {
                const trimmedLine = line.trim();
                const result = evaluateLine(trimmedLine);
                
                if (result !== null && result !== undefined) {
                    outputHTML += `<div class="flex items-start">
                                      <span class="mr-4 text-blue-400 font-bold">></span>
                                      <span class="flex-1">${line}</span>
                                      <span class="flex-1 text-right text-gray-400">= ${result}</span>
                                  </div>`;
                } else if (trimmedLine.length > 0) {
                    outputHTML += `<div class="flex items-start">
                                      <span class="mr-4 text-gray-500 font-bold">></span>
                                      <span class="flex-1 text-gray-500">${line}</span>
                                  </div>`;
                }
            });
            
            outputArea.innerHTML = outputHTML || '<div class="text-gray-400">Your results will appear here in real-time.</div>';
        };

        // --- Event Listeners ---

        // Event listener for real-time processing as the user types
        inputArea.addEventListener('input', processInput);
        
        // Event listener for the erase button
        eraseButton.addEventListener('click', () => {
            inputArea.value = '';
            processInput();
            showMessage('Calculator cleared!');
        });
        
        // Event listeners for save buttons
        saveButtons.forEach(button => {
            button.addEventListener('click', () => {
                const slot = button.id.split('-')[1];
                const key = `instacalc_slot_${slot}`;
                const currentValue = inputArea.value;

                if (localStorage.getItem(key)) {
                    // Show confirmation modal
                    confirmModal.classList.remove('hidden');
                    confirmModal.classList.add('flex');
                    
                    // Handle user's choice
                    confirmOk.onclick = () => {
                        localStorage.setItem(key, currentValue);
                        confirmModal.classList.add('hidden');
                        confirmModal.classList.remove('flex');
                        showMessage(`Calculation saved to slot ${slot}!`);
                    };
                    confirmCancel.onclick = () => {
                        confirmModal.classList.add('hidden');
                        confirmModal.classList.remove('flex');
                    };
                } else {
                    localStorage.setItem(key, currentValue);
                    showMessage(`Calculation saved to slot ${slot}!`);
                }
            });
        });

        // Event listeners for load buttons
        loadButtons.forEach(button => {
            button.addEventListener('click', () => {
                const slot = button.id.split('-')[1];
                const key = `instacalc_slot_${slot}`;
                const savedValue = localStorage.getItem(key);

                if (savedValue) {
                    inputArea.value = savedValue;
                    processInput();
                    showMessage(`Calculation loaded from slot ${slot}!`);
                } else {
                    showMessage(`Slot ${slot} is empty.`);
                }
            });
        });

        // Initial processing on page load
        window.addEventListener('DOMContentLoaded', () => {
             // Set a default value and trigger the initial calculation
            inputArea.value = `// Welcome to Insta-Clone!
// Now supports date, time, percentage, and unit calculations.

// Date calculations with variables
y = 20
today + y days

// Expanded date calculations (weeks, months, years)
today + 3 weeks
today - 6 months
today + 2 years

// Time calculations
14:00 + 4 hours
9:30 AM + 30 minutes

// Use the buttons at the bottom of the page to save and load your work.

// Percentage calculations
340 + 15%

// Unit conversions
23 usd to eur
100 m to ft

// You can use conversions with variables too
distance_m = 50
distance_m to cm

// The result of the last line will be displayed
25 gbp to usd`;
            processInput();
        });

    </script>
</body>
</html>
