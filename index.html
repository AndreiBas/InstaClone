<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta-Clone Calculator</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

        /* Styles for the contenteditable div (our new input area) */
        #inputArea {
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
            outline: none;
            resize: none;
            line-height: 1.5;
            padding: 1rem;
            color: #d1d5db; /* Light gray text */
            background-color: #111827; /* Dark background */
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            caret-color: #fff; /* White cursor */
            overflow-y: auto; /* Enable scrolling */
        }
        /* Style for the syntax-highlighted spans */
        #inputArea .variable-new, .output-highlight .variable-new {
            color: #60a5fa; /* Blue */
        }
        #inputArea .variable-redefined, .output-highlight .variable-redefined {
            color: #f87171; /* Red */
        }
        #inputArea .variable-used, .output-highlight .variable-used {
            color: #fb923c; /* Orange-400 */
        }
        #inputArea .comment, .output-highlight .comment {
            color: #facc15; /* Yellow */
        }
        #inputArea .operator, .output-highlight .operator {
            color: #a1a1aa; /* Gray-400 for operators like = */
        }
        #inputArea .keyword, .output-highlight .keyword {
            color: #c084fc; /* Purple-400 for keywords like 'today' and 'to' */
        }
        #inputArea .unit, .output-highlight .unit {
            color: #2dd4bf; /* Teal-400 for units like 'usd', 'm', 'days' */
        }
        
        /* Styles for Autocomplete Popup */
        #autocomplete-popup {
            position: absolute;
            z-index: 100;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-height: 200px;
            overflow-y: auto;
            min-width: 150px;
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        
        /* Custom styles for the toggle switch */
        .toggle-switch-container { display: inline-block; height: 24px; position: relative; width: 48px; }
        .toggle-switch-container input { display: none; }
        .toggle-slider { background-color: #4b5563; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { background-color: white; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #22c55e; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Styles for collapsible loops */
        .loop-header {
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .toggle-icon {
            margin-right: 0.5rem;
            color: #9ca3af; /* gray-400 */
            transition: transform 0.2s;
            width: 1rem; 
        }
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        
        /* Styles for Help Modal Content */
        #help-content h5 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #c084fc; /* purple-400 */
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding-bottom: 0.25rem;
        }
        #help-content code {
            display: block;
            background-color: #111827; /* gray-900 */
            padding: 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 0.5rem;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            color: #9ca3af; /* gray-400 */
        }
        #help-content p {
            margin-bottom: 0.5rem;
        }
        #help-content strong {
            color: #a5b4fc; /* indigo-300 */
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased flex flex-col items-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row flex-shrink-0 md:flex-1 md:min-h-0">
        <!-- Left Panel: Input Area -->
        <div class="flex-1 flex flex-col p-4 md:p-8 h-72 md:h-auto">
            <div class="flex justify-between items-center mb-2 h-12 gap-2 md:gap-4">
                <input type="text" id="calculationNameInput" placeholder="Calculation Name..." class="text-xl md:text-2xl font-bold text-white bg-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 py-1 w-full -ml-2">
                <button id="eraseButton" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 flex-shrink-0">Erase</button>
            </div>
            
            <div class="relative flex-1 min-h-0">
                <div id="inputArea" contenteditable="true" class="w-full h-full rounded-xl bg-gray-900 text-gray-200 font-mono text-base md:text-lg"></div>
                <div id="autocomplete-popup" class="hidden"></div>
            </div>
        </div>
        <!-- Right Panel: Output Area -->
        <div class="flex-1 flex flex-col p-4 md:p-8 border-t-2 md:border-t-0 md:border-l-2 border-gray-700 bg-gray-700/30 h-72 md:h-auto">
            <div class="flex justify-between items-center mb-2 h-12">
                <h2 class="text-2xl font-bold text-white">Results</h2>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-400 text-sm">No sleep</label>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="noSleepToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-400 text-sm">Round</label>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="roundingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="outputArea" class="relative flex-1 bg-gray-900 rounded-xl p-4 overflow-y-auto text-gray-200 font-mono text-base md:text-lg">
                <div class="text-gray-400">Your results will appear here in real-time.</div>
            </div>
        </div>
    </div>

    <!-- Saved Calculations Section -->
    <div class="w-full max-w-6xl mt-4 p-4 md:p-6 bg-gray-800 rounded-2xl shadow-2xl">
        <h3 class="text-lg font-semibold text-white mb-2">Quick Save Slots</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            <button id="save-1" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 1</button>
            <button id="save-2" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 2</button>
            <button id="save-3" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 3</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-2">
            <button id="load-1" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 1</button>
            <button id="load-2" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 2</button>
            <button id="load-3" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 3</button>
        </div>
        <div class="mt-4 flex flex-wrap justify-center gap-2">
            <button id="saveToFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Save to File</button>
            <button id="loadFromFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Load from File</button>
            <button id="helpButton" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-purple-700 flex-grow sm:flex-grow-0">Show Help</button>
        </div>
        <input type="file" id="fileLoader" class="hidden" accept=".txt,.text/plain,.json">
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-gray-700">
            <h4 class="text-xl font-bold mb-4">Overwrite Calculation?</h4>
            <p class="text-gray-400 mb-6">This slot already has a saved calculation. Do you want to replace it?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel" class="bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>
    
    <!-- MODIFIED: Message box is now positioned at the top -->
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-lg shadow-lg z-50 hidden opacity-0 transition-opacity duration-300"><p id="message-text"></p></div>

    <div id="help-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
            <h4 class="text-2xl font-bold mb-4 text-white">Insta-Clone Help</h4>
            <div id="help-content" class="flex-1 overflow-y-auto text-gray-300 space-y-4 pr-4"></div>
            <div class="flex justify-end mt-6">
                <button id="help-close-button" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-purple-700">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // --- Core Application Logic ---
        
        const $ = (selector) => document.querySelector(selector);
        
        const inputArea = $('#inputArea');
        const outputArea = $('#outputArea');
        const eraseButton = $('#eraseButton');
        const calculationNameInput = $('#calculationNameInput');
        const autocompletePopup = $('#autocomplete-popup');
        const confirmModal = $('#confirm-modal');
        const messageBox = $('#message-box');
        const roundingToggle = $('#roundingToggle');
        const noSleepToggle = $('#noSleepToggle');
        const helpButton = $('#helpButton');
        const helpModal = $('#help-modal');
        const helpContent = $('#help-content');
        const helpCloseButton = $('#help-close-button');
        const saveToFileButton = $('#saveToFileButton');
        const loadFromFileButton = $('#loadFromFileButton');
        const fileLoaderInput = $('#fileLoader');

        let variables = {};
        let wakeLock = null;
        let autocompleteState = { active: false, suggestions: [], selectedIndex: -1, wordStartIndex: -1 };
        
        const HELP_CONTENT_INPUT = `// Welcome to Insta-Clone!
// Variables are NOT case-sensitive.
// For example, 'cost' and 'Cost' are the same.

Cost = 150
tax_rate = 10
total = Cost + tax_rate%`;

        const HELP_CONTENT_POPUP_HTML = `
            <p>Welcome to Insta-Clone! This is a real-time calculator that understands variables, loops, and more. Type on the left and see the results on the right.</p>
            
            <h5>Getting Started: The Basics</h5>
            <p><strong>Variables:</strong> Names are <strong>not case-sensitive</strong> (so <code>rent</code> and <code>Rent</code> are the same).</p>
            <code>rent = 1200
utilities = 250
total_cost = Rent + utilities</code>

            <p><strong>Math Operations:</strong> Use standard operators like <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code> and group with parentheses <code>()</code>.</p>
            <code>(100 - 25) * 2</code>

            <p><strong>Comments:</strong> Use <code>//</code> to add notes. Anything after it on a line is ignored.</p>
            <code>income = 5000 // Gross monthly salary</code>

            <h5>Advanced Calculations</h5>
            <p><strong>Percentages:</strong> Easily add, subtract, or find a percentage.</p>
            <code>500 + 10%       // Adds 10% of 500
120 - 25%       // Subtracts 25% of 120
15% of 300      // Calculates 15% of 300</code>

            <p><strong>Date Math:</strong> Use the <code>today</code> keyword to find future or past dates.</p>
            <code>project_due = today + 90 days
last_meeting = today - 3 weeks</code>

            <p><strong>Unit Conversions:</strong> Convert values using the format: <code>value from_unit to to_unit</code>.</p>
            <code>100 usd to gbp
2.5 m to ft
10 cm to inch</code>

            <h5>Automating with Loops</h5>
            <p><strong>For Loops:</strong> Run code multiple times with <code>for variable = start to end</code> and finish with <code>endfor</code>.</p>
            <code>total = 0
for i = 1 to 5
  total = total + i
endfor</code>

            <h5>Managing Your Work</h5>
            <p><strong>Calculation Name:</strong> Edit the name at the top-left. This is used when saving to a file.</p>
            <p><strong>Quick Save & Load:</strong> Use the "Save 1/2/3" and "Load 1/2/3" buttons for quick storage in your browser.</p>
            <p><strong>Save & Load from File:</strong> Use "Save to File" to download your work. Use "Load from File" to open it later.</p>
            
            <h5>Interface & Tips</h5>
            <p><strong>Autocomplete:</strong> Start typing a variable or keyword and a suggestion box will appear. Press <strong>Tab</strong> or <strong>Enter</strong> to accept.</p>
            <p><strong>Collapsible Results:</strong> In the Results panel, click the '►' icon on a loop header to expand or collapse its output.</p>
            <p><strong>Rounding Toggle:</strong> Enable this to format all decimal results to two decimal places.</p>
            <p><strong>No Sleep Toggle:</strong> Enable this to prevent your device's screen from turning off.</p>
        `;

        const inchRates = { cm: 2.54, m: 0.0254, ft: 1/12 };
        const conversionRates = {
            // Currency
            usd: { eur: 0.92, gbp: 0.78 }, eur: { usd: 1.09, gbp: 0.85 }, gbp: { usd: 1.28, eur: 1.17 },
            // Length
            m: { ft: 3.28084, cm: 100, in: 39.3701, inch: 39.3701 },
            ft: { m: 0.3048, cm: 30.48, in: 12, inch: 12 },
            cm: { m: 0.01, ft: 0.0328084, in: 0.393701, inch: 0.393701 },
            in: inchRates,
            inch: inchRates,
            // Weight
            kg: { lb: 2.20462 }, lb: { kg: 0.453592 },
        };

        const specialWords = {
            'today': 'keyword', 'to': 'keyword', 'for': 'keyword', 'endfor': 'keyword', 'of': 'keyword',
            'usd': 'unit', 'eur': 'unit', 'gbp': 'unit',
            'm': 'unit', 'ft': 'unit', 'cm': 'unit', 'kg': 'unit', 'lb': 'unit', 'in': 'unit', 'inch': 'unit',
            'days': 'unit', 'day': 'unit', 'weeks': 'unit', 'week': 'unit', 'months': 'unit', 'month': 'unit',
            'years': 'unit', 'year': 'unit', 'hours': 'unit', 'hour': 'unit', 'minutes': 'unit', 'minute': 'unit',
        };

        const setDefaultCalculationName = () => {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yy = today.getFullYear().toString().slice(-2);
            calculationNameInput.value = `Insta-Clone ${mm}-${dd}-${yy}`;
        };

        const getAutocompleteKeywords = (textContent) => {
            const orderedVars = [];
            textContent.split('\n').forEach(line => {
                const match = line.trim().match(/^([a-zA-Z_]\w*)\s*=/);
                if (match) {
                    const varName = match[1].toLowerCase();
                    const existingIndex = orderedVars.indexOf(varName);
                    if (existingIndex > -1) orderedVars.splice(existingIndex, 1);
                    orderedVars.push(varName);
                }
            });
            const newestVarsFirst = orderedVars.reverse();
            const specialKeywordsList = Object.keys(specialWords);
            return [...newestVarsFirst, ...specialKeywordsList.filter(k => !orderedVars.includes(k))];
        };
        
        // --- Helper Functions ---

        const showMessage = (text) => {
            $('#message-text').textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.remove('opacity-0'), 10);
            setTimeout(() => { messageBox.classList.add('opacity-0'); setTimeout(() => messageBox.classList.add('hidden'), 3000); }, 3000);
        };

        const calculate = (expression) => {
            if (!expression) return undefined;
            // Handle "15% of 300"
            const percentageOfMatch = expression.match(/(\d+(?:\.\d+)?)%\s*of\s*(\d+(?:\.\d+)?)/i);
            if (percentageOfMatch) {
                const [, perc, num] = percentageOfMatch;
                return (parseFloat(perc) / 100) * parseFloat(num);
            }
            const conversionMatch = expression.match(/(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\s*to\s*([a-zA-Z]+)$/);
            if (conversionMatch) {
                const [, value, fromUnit, toUnit] = conversionMatch.map(s => s.toLowerCase());
                if (conversionRates[fromUnit]?.[toUnit]) return parseFloat(value) * conversionRates[fromUnit][toUnit];
                return `Error: Unsupported conversion.`;
            }
            expression = expression.replace(/(\d+(?:\.\d+)?)\s*([+\-*/])\s*(\d+(?:\.\d+)?)%/g, (match, base, op, perc) => {
                const p = parseFloat(perc) / 100;
                return op === '+' || op === '-' ? `${base} ${op} (${base} * ${p})` : `${base} ${op} ${p}`;
            });
            try {
                const result = new Function(`return ${expression}`)();
                return (typeof result === 'number' && !isNaN(result)) ? result : undefined;
            } catch { return undefined; }
        };

        const replaceVariables = (expression) => {
            return Object.keys(variables).sort((a, b) => b.length - a.length)
                .reduce((expr, key) => expr.replace(new RegExp(`\\b${key}\\b`, 'gi'), variables[key]), expression);
        };
        
        const evaluateLine = (line) => {
            line = line.trim();
            if (!line || line.startsWith('//') || line.startsWith('for') || line === 'endfor') return null;

            const assignmentMatch = line.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);
            if (assignmentMatch) {
                const [, varName, expression] = assignmentMatch;
                const result = calculate(replaceVariables(expression.trim()));
                variables[varName.toLowerCase()] = result;
                return result;
            }
            const dateMatch = line.match(/^today\s*([+\-])\s*([a-zA-Z_]\w*|\d+)\s*(days?|weeks?|months?|years?)$/i);
            if (dateMatch) {
                const [, operator, valuePart, unit] = dateMatch;
                const value = isNaN(valuePart) ? parseInt(variables[valuePart.toLowerCase()], 10) : parseInt(valuePart, 10);
                if (isNaN(value)) return `Error: Invalid number.`;
                const today = new Date();
                const mult = operator === '+' ? 1 : -1;
                const u = unit.toLowerCase();
                if (u.startsWith('day')) today.setDate(today.getDate() + value * mult);
                else if (u.startsWith('week')) today.setDate(today.getDate() + value * 7 * mult);
                else if (u.startsWith('month')) today.setMonth(today.getMonth() + value * mult);
                else if (u.startsWith('year')) today.setFullYear(today.getFullYear() + value * mult);
                return today.toDateString();
            }
            return calculate(replaceVariables(line));
        };
        
        const formatResult = (result) => {
            if (typeof result === 'number' && roundingToggle.checked) {
                if (!Number.isInteger(result)) return result.toFixed(2);
            }
            if (result === undefined || result === null) return '';
            return result;
        };

        const highlightText = (line, definedVars) => {
            const escapeHtml = (text) => text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const commentIndex = line.indexOf('//');
            const codePart = commentIndex !== -1 ? line.substring(0, commentIndex) : line;
            const commentPart = commentIndex !== -1 ? `<span class="comment">${escapeHtml(line.substring(commentIndex))}</span>` : '';
            const assignmentMatch = codePart.trim().match(/^([a-zA-Z_]\w*)\s*=/);
            const varNameOnLine = assignmentMatch ? assignmentMatch[1].toLowerCase() : null;
            
            const tokens = codePart.split(/(\b[a-zA-Z_]\w*\b|=|\s+)/).filter(Boolean);

            const processedCode = tokens.map(token => {
                const trimmedToken = token.trim().toLowerCase();
                if (token.trim() === '') return token;
                if (token === '=') return `<span class="operator">${token}</span>`;
                if (specialWords[trimmedToken]) return `<span class="${specialWords[trimmedToken]}">${escapeHtml(token)}</span>`;
                if (trimmedToken === varNameOnLine) {
                    return `<span class="${definedVars.has(trimmedToken) ? 'variable-redefined' : 'variable-new'}">${escapeHtml(token)}</span>`;
                }
                if (definedVars.has(trimmedToken)) {
                    return `<span class="variable-used">${escapeHtml(token)}</span>`;
                }
                return escapeHtml(token);
            }).join('');
            return processedCode + commentPart;
        };

        const processInput = () => {
            highlightInput();
            variables = {};
            const lines = inputArea.textContent.split('\n');
            let outputHTML = '';
            let loopIdCounter = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                const forLoopMatch = trimmedLine.match(/^for\s+([a-zA-Z_]\w*)\s*=\s*(.*?)\s+to\s+(.*?)\s*$/i);

                if (forLoopMatch) {
                    loopIdCounter++;
                    const loopBodyId = `loop-body-${loopIdCounter}`;
                    const [, iterator, startExpr, endExpr] = forLoopMatch;
                    const iteratorLower = iterator.toLowerCase();
                    let endforIndex = -1;
                    let nestingLevel = 0;
                    for (let j = i + 1; j < lines.length; j++) {
                        if (lines[j].trim().match(/^for\s/i)) nestingLevel++;
                        if (lines[j].trim().toLowerCase() === 'endfor') {
                            if (nestingLevel === 0) { endforIndex = j; break; } else { nestingLevel--; }
                        }
                    }

                    if (endforIndex === -1) {
                        outputHTML += `<div class="text-red-400">Error: Missing 'endfor'.</div>`;
                        continue;
                    }
                    
                    const highlightedHeader = highlightText(line, new Set(Object.keys(variables)));
                    outputHTML += `<div class="loop-header" data-target-id="${loopBodyId}"><span class="toggle-icon">►</span><div class="flex items-start output-highlight flex-1"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedHeader}</span></div></div>`;

                    let loopBodyHTML = '';
                    const loopBodyLines = lines.slice(i + 1, endforIndex);
                    const startValue = Math.round(calculate(replaceVariables(startExpr.trim())));
                    const endValue = Math.round(calculate(replaceVariables(endExpr.trim())));

                    if (isNaN(startValue) || isNaN(endValue)) {
                        loopBodyHTML = `<div class="text-red-400 ml-8">Error: Loop bounds must be numbers.</div>`;
                    } else {
                        for (let k = startValue; k <= endValue; k++) {
                            variables[iteratorLower] = k;
                            loopBodyLines.forEach(bodyLine => {
                                const result = evaluateLine(bodyLine);
                                const highlightedBodyLine = highlightText(bodyLine, new Set(Object.keys(variables)));
                                if (result !== null && result !== undefined) {
                                    loopBodyHTML += `<div class="flex items-start output-highlight ml-8"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1">${highlightedBodyLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`;
                                } else if (bodyLine.trim()) {
                                    loopBodyHTML += `<div class="flex items-start output-highlight ml-8"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedBodyLine}</span></div>`;
                                } else {
                                    loopBodyHTML += `<div class="h-6 ml-8"></div>`;
                                }
                            });
                        }
                        delete variables[iteratorLower];
                    }
                    
                    loopBodyHTML += `<div class="flex items-start output-highlight"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightText(lines[endforIndex], new Set(Object.keys(variables)))}</span></div>`;
                    outputHTML += `<div id="${loopBodyId}" class="loop-body hidden">${loopBodyHTML}</div>`;
                    i = endforIndex;

                } else if (trimmedLine.toLowerCase() === 'endfor') {
                    outputHTML += `<div class="text-red-400">Error: Unexpected 'endfor'.</div>`;
                } else {
                    if (!trimmedLine) {
                        outputHTML += `<div class="h-6"></div>`;
                    } else {
                        const lineVars = new Set(Object.keys(variables));
                        const result = evaluateLine(line);
                        const highlightedLine = highlightText(line, lineVars);
                        if (result !== null && result !== undefined) {
                            outputHTML += `<div class="flex items-start output-highlight"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1">${highlightedLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`;
                        } else {
                            outputHTML += `<div class="flex items-start output-highlight"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedLine}</span></div>`;
                        }
                    }
                }
            }
            outputArea.innerHTML = outputHTML || '<div class="text-gray-400">Your results will appear here in real-time.</div>';
        };

        const highlightInput = () => {
            const selection = window.getSelection();
            const savedOffset = (selection.rangeCount > 0) ? (() => {
                const range = selection.getRangeAt(0).cloneRange();
                range.selectNodeContents(inputArea);
                range.setEnd(selection.getRangeAt(0).startContainer, selection.getRangeAt(0).startOffset);
                return range.toString().length;
            })() : 0;

            const definedVariables = new Set();
            const lines = inputArea.textContent.split('\n');
            const highlightedLines = lines.map(line => {
                const highlighted = highlightText(line, definedVariables);
                const assignmentMatch = line.trim().match(/^([a-zA-Z_]\w*)\s*=/);
                if (assignmentMatch) definedVariables.add(assignmentMatch[1].toLowerCase());
                return highlighted;
            });
            
            inputArea.innerHTML = highlightedLines.join('\n');

            let charCount = 0;
            const newRange = document.createRange();
            const treeWalker = document.createTreeWalker(inputArea, NodeFilter.SHOW_TEXT);
            let node;
            while (node = treeWalker.nextNode()) {
                if (charCount + node.length >= savedOffset) {
                    newRange.setStart(node, savedOffset - charCount);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                    return;
                }
                charCount += node.length;
            }
            newRange.selectNodeContents(inputArea);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
        };

        // --- Autocomplete ---
        function updateAutocompletePopup() {
            if (!autocompleteState.active || autocompleteState.suggestions.length === 0) return autocompletePopup.classList.add('hidden');
            autocompletePopup.innerHTML = autocompleteState.suggestions.map((s, i) => `<div class="autocomplete-item ${i === autocompleteState.selectedIndex ? 'selected' : ''}" data-index="${i}">${s}</div>`).join('');
            const range = window.getSelection().getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const inputRect = inputArea.getBoundingClientRect();
            autocompletePopup.style.left = `${rect.left - inputRect.left}px`;
            autocompletePopup.style.top = `${rect.bottom - inputRect.top + 5}px`;
            autocompletePopup.classList.remove('hidden');
        }

        function closeAutocomplete() { autocompleteState.active = false; autocompletePopup.classList.add('hidden'); }
        
        function handleAutocomplete() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return closeAutocomplete();
            const range = selection.getRangeAt(0);
            const textBeforeCursor = range.startContainer.textContent.substring(0, range.startOffset);
            if (/\W$/.test(textBeforeCursor) || textBeforeCursor.length === 0) return closeAutocomplete();
            const wordMatch = textBeforeCursor.match(/(\w+)$/);
            if (!wordMatch) return closeAutocomplete();
            
            const currentWord = wordMatch[1];
            const lowerCurrentWord = currentWord.toLowerCase();
            autocompleteState.wordStartIndex = textBeforeCursor.length - currentWord.length;
            const suggestions = getAutocompleteKeywords(inputArea.textContent).filter(kw => 
                kw.startsWith(lowerCurrentWord) && kw !== lowerCurrentWord
            );

            if (suggestions.length > 0) {
                autocompleteState.active = true;
                autocompleteState.suggestions = suggestions;
                autocompleteState.selectedIndex = 0;
            } else { closeAutocomplete(); }
            updateAutocompletePopup();
        }

        function acceptSuggestion(suggestion) {
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const node = range.startContainer;
            const textBefore = node.textContent.substring(0, autocompleteState.wordStartIndex);
            const textAfter = node.textContent.substring(range.startOffset);
            node.textContent = `${textBefore}${suggestion} ${textAfter}`;
            range.setStart(node, (textBefore + suggestion + ' ').length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            closeAutocomplete();
            inputArea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // --- Event Listeners ---
        inputArea.addEventListener('keydown', (event) => {
            if (autocompleteState.active) {
                if (['ArrowDown', 'ArrowUp', 'Escape', 'Enter', 'Tab'].includes(event.key)) {
                    event.preventDefault();
                    if (event.key === 'ArrowDown') {
                        autocompleteState.selectedIndex = (autocompleteState.selectedIndex + 1) % autocompleteState.suggestions.length;
                        updateAutocompletePopup();
                    } else if (event.key === 'ArrowUp') {
                        autocompleteState.selectedIndex = (autocompleteState.selectedIndex - 1 + autocompleteState.suggestions.length) % autocompleteState.suggestions.length;
                        updateAutocompletePopup();
                    } else if (event.key === 'Escape') {
                        closeAutocomplete();
                    } else if (event.key === 'Enter' || event.key === 'Tab') {
                        acceptSuggestion(autocompleteState.suggestions[autocompleteState.selectedIndex]);
                    }
                    return;
                }
            }
            if (event.key === 'Enter') {
                event.preventDefault();
                document.execCommand('insertLineBreak');
                inputArea.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });

        inputArea.addEventListener('input', () => {
            processInput();
            handleAutocomplete();
        });
        
        roundingToggle.addEventListener('change', processInput);
        
        document.addEventListener('click', (e) => !autocompletePopup.contains(e.target) && closeAutocomplete());
        autocompletePopup.addEventListener('click', (e) => e.target.closest('.autocomplete-item') && acceptSuggestion(autocompleteState.suggestions[parseInt(e.target.dataset.index)]));
        
        eraseButton.addEventListener('click', () => {
            inputArea.textContent = '';
            processInput();
            setDefaultCalculationName();
            showMessage('Calculator cleared!');
        });
        
        outputArea.addEventListener('click', (e) => {
            const header = e.target.closest('.loop-header');
            if (header) {
                const targetId = header.dataset.targetId;
                const body = $(`#${targetId}`);
                const icon = header.querySelector('.toggle-icon');
                if (body) {
                    body.classList.toggle('hidden');
                    icon.classList.toggle('expanded');
                    icon.innerHTML = icon.classList.contains('expanded') ? '▼' : '►';
                }
            }
        });

        // Quick Save/Load Logic
        for (let i = 1; i <= 3; i++) {
            $(`#save-${i}`).addEventListener('click', () => {
                const key = `instacalc_slot_${i}`;
                const dataToSave = {
                    name: calculationNameInput.value,
                    content: inputArea.textContent
                };
                const saveData = JSON.stringify(dataToSave);

                if (localStorage.getItem(key)) {
                    confirmModal.classList.add('flex'); confirmModal.classList.remove('hidden');
                    $('#confirm-ok').onclick = () => { localStorage.setItem(key, saveData); confirmModal.classList.add('hidden'); showMessage(`Saved to slot ${i}!`); };
                    $('#confirm-cancel').onclick = () => confirmModal.classList.add('hidden');
                } else {
                    localStorage.setItem(key, saveData);
                    showMessage(`Saved to slot ${i}!`);
                }
            });
            $(`#load-${i}`).addEventListener('click', () => {
                const savedValue = localStorage.getItem(`instacalc_slot_${i}`);
                if (savedValue) {
                    try {
                        const data = JSON.parse(savedValue);
                        calculationNameInput.value = data.name || 'Insta-Clone';
                        inputArea.textContent = data.content || '';
                    } catch (e) {
                        // Handle old plain-text format for backward compatibility
                        inputArea.textContent = savedValue;
                        setDefaultCalculationName();
                    }
                    processInput();
                    showMessage(`Loaded from slot ${i}!`);
                } else {
                    showMessage(`Slot ${i} is empty.`);
                }
            });
        }
        
        // File Save Logic
        saveToFileButton.addEventListener('click', () => {
            const dataToSave = {
                name: calculationNameInput.value,
                content: inputArea.textContent
            };
            const textToSave = JSON.stringify(dataToSave, null, 2); // Pretty-print JSON

            if (!dataToSave.content.trim()) {
                showMessage('Nothing to save!');
                return;
            }
            
            let baseName = calculationNameInput.value.trim() || 'Calculation';
            const sanitizedBaseName = baseName.replace(/[\/\\?%*:|"<>]/g, '').replace(/\s+/g, '_');
            
            const blob = new Blob([textToSave], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `IC_${sanitizedBaseName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('File download started!');
        });

        loadFromFileButton.addEventListener('click', () => {
            fileLoaderInput.click();
        });

        // File Load Logic
        fileLoaderInput.addEventListener('change', (event) => {
            if (!event.target.files || event.target.files.length === 0) return;
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const fileContent = e.target.result;
                try {
                    const data = JSON.parse(fileContent);
                    // Check if it's our specific JSON format
                    if (data && typeof data === 'object' && data.hasOwnProperty('content')) {
                        calculationNameInput.value = data.name || 'Insta-Clone';
                        inputArea.textContent = data.content || '';
                    } else {
                        // It's some other valid JSON, treat as text
                        throw new Error("Not our format"); 
                    }
                } catch (err) {
                    // It's not JSON, must be old plain-text format
                    inputArea.textContent = fileContent;
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // remove extension
                    calculationNameInput.value = fileName;
                }
                processInput();
                showMessage(`File "${file.name}" loaded!`);
            };

            reader.onerror = () => showMessage(`Error reading file: ${reader.error}`);
            reader.readAsText(file);
            event.target.value = null;
        });

        noSleepToggle.addEventListener('change', async (e) => {
            if (e.target.checked) {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLock.addEventListener('release', () => { if(e.target.checked) { e.target.checked = false; showMessage('Wake lock released.'); }});
                        showMessage('Screen wake lock active.');
                    } catch (err) { showMessage(`Error: ${err.message}`); e.target.checked = false; }
                } else { showMessage('Wake Lock API not supported.'); e.target.checked = false; }
            } else if (wakeLock) { wakeLock.release(); wakeLock = null; }
        });
        
        helpButton.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
            helpModal.classList.add('flex');
        });
        helpCloseButton.addEventListener('click', () => {
            helpModal.classList.add('hidden');
            helpModal.classList.remove('flex');
        });

        window.addEventListener('DOMContentLoaded', () => {
            helpContent.innerHTML = HELP_CONTENT_POPUP_HTML;
            inputArea.textContent = HELP_CONTENT_INPUT;
            setDefaultCalculationName(); 
            document.execCommand("defaultParagraphSeparator", false, "br");
            processInput();
        });

    </script>
</body>
</html>
