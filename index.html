<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta-Clone Calculator</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pako.js for compression/decompression for sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

        /* Styles for the dual-layer input area */
        .input-container {
            position: relative;
            flex: 1;
            min-height: 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 1rem; /* text-base */
            line-height: 1.5;
        }
        @media (min-width: 768px) {
            .input-container { font-size: 1.125rem; } /* md:text-lg */
        }

        #highlightingArea, #inputArea, #autocomplete-mirror {
            padding: 1rem;
            margin: 0;
            border: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            border-radius: 0.75rem; /* rounded-xl */
            font: inherit; /* Ensure all layers use the container's font settings */
        }
        
        #highlightingArea {
            background-color: #111827; /* gray-900 */
            z-index: 1;
            pointer-events: none; /* Clicks go through to the input area */
            color: #d1d5db; /* Default text color */
        }
        
        #highlightingArea > div {
            min-height: 1.5em; /* Match line-height to prevent collapse of empty lines */
        }

        #inputArea {
            z-index: 2;
            background-color: transparent;
            color: transparent; /* Make the actual text invisible */
            caret-color: #fff; /* But keep the cursor visible */
            resize: none;
            outline: none;
        }

        #autocomplete-mirror {
            z-index: -1; /* Keep it out of sight and non-interactive */
            visibility: hidden;
            pointer-events: none;
        }


        /* Style for the syntax-highlighted spans */
        .variable-new { color: #60a5fa; } .variable-redefined { color: #f87171; } .variable-used { color: #fb923c; } .comment { color: #facc15; } .operator { color: #a1a1aa; } .keyword { color: #c084fc; } .unit { color: #2dd4bf; }
        
        /* Styles for Autocomplete Popup */
        #autocomplete-popup {
            position: absolute; z-index: 100; background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); max-height: 200px; overflow-y: auto; min-width: 150px;
        }
        .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; color: #d1d5db; }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: #4f46e5; color: white; }
        
        /* Custom styles for the toggle switch */
        .toggle-switch-container { display: inline-block; height: 24px; position: relative; width: 48px; }
        .toggle-switch-container input { display: none; }
        .toggle-slider { background-color: #4b5563; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { background-color: white; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #22c55e; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Styles for collapsible loops */
        .loop-header { cursor: pointer; display: flex; align-items: center; }
        .toggle-icon { margin-right: 0.5rem; color: #9ca3af; transition: transform 0.2s; width: 1rem; }
        .toggle-icon.expanded { transform: rotate(90deg); }
        
        /* Styles for Help Modal Content */
        #help-content h5 { font-size: 1.125rem; font-weight: 600; color: #c084fc; margin-top: 1.25rem; margin-bottom: 0.75rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.25rem; }
        #help-content code { display: block; background-color: #111827; padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; color: #9ca3af; }
        #help-content p { margin-bottom: 0.5rem; }
        #help-content strong { color: #a5b4fc; font-weight: 500; }

        /* Style for line highlighting on hover */
        .line-highlight {
            background-color: rgba(75, 85, 99, 0.5); /* gray-600 with 50% opacity */
            transition: background-color 0.1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased flex flex-col items-center min-h-screen p-2 sm:p-4">

    <!-- MODIFIED: Changed layout from Flexbox to CSS Grid for robust panel sizing -->
    <div class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden grid grid-rows-2 md:grid-rows-1 md:grid-cols-2 flex-1 min-h-0">
        <!-- MODIFIED: Removed sizing classes like flex-1, md:w-1/2. The parent grid now controls sizing. Added min-h-0. -->
        <div class="flex flex-col p-4 md:p-8 min-h-0">
            <div class="flex justify-between items-center mb-2 h-12 gap-2 md:gap-4 flex-shrink-0">
                <input type="text" id="calculationNameInput" placeholder="Calculation Name..." class="text-xl md:text-2xl font-bold text-white bg-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 py-1 w-full -ml-2">
                <button id="eraseButton" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 flex-shrink-0">Erase</button>
            </div>
            
            <div class="input-container">
                <div id="highlightingArea" aria-hidden="true"></div>
                <div id="autocomplete-mirror" aria-hidden="true"></div>
                <textarea id="inputArea" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off"></textarea>
                <div id="autocomplete-popup" class="hidden"></div>
            </div>
        </div>
        <!-- MODIFIED: Removed sizing classes. Added border classes for mobile/desktop. Added min-h-0. -->
        <div class="flex flex-col p-4 md:p-8 border-t-2 md:border-t-0 md:border-l-2 border-gray-700 bg-gray-700/30 min-h-0">
            <div class="flex justify-between items-center mb-2 min-h-[3rem] h-auto flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">Results</h2>
                <div class="flex items-center justify-end flex-wrap gap-x-4 gap-y-2">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-400 text-sm">Clean view</label>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="cleanViewToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-400 text-sm">No sleep</label>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="noSleepToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-400 text-sm">Round</label>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="roundingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="outputArea" class="relative flex-1 bg-gray-900 rounded-xl p-4 overflow-y-auto text-gray-200 font-mono text-base md:text-lg">
                <div class="text-gray-400">Your results will appear here in real-time.</div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-6xl mt-2 md:hidden">
        <button id="toggleControlsButton" class="w-full bg-gray-700 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-gray-600">
            Manage Saves & Files
        </button>
    </div>

    <div id="controls-panel" class="w-full max-w-6xl mt-4 p-4 md:p-6 bg-gray-800 rounded-2xl shadow-2xl hidden md:block">
        <h3 class="text-lg font-semibold text-white mb-2">Quick Save Slots</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            <button id="save-1" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 1</button>
            <button id="save-2" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 2</button>
            <button id="save-3" class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Save 3</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-2">
            <button id="load-1" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 1</button>
            <button id="load-2" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 2</button>
            <button id="load-3" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Load 3</button>
        </div>
        <div class="mt-4 flex flex-wrap justify-center gap-2">
            <button id="saveToFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Save to File</button>
            <button id="loadFromFileButton" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex-grow sm:flex-grow-0">Load from File</button>
            <button id="shareButton" class="bg-teal-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 flex-grow sm:flex-grow-0">Share</button>
            <button id="helpButton" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-purple-700 flex-grow sm:flex-grow-0">Show Help</button>
        </div>
        <input type="file" id="fileLoader" class="hidden" accept=".txt,.text/plain,.json">
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-gray-700">
            <h4 class="text-xl font-bold mb-4">Overwrite Calculation?</h4>
            <p class="text-gray-400 mb-6">This slot already has a saved calculation. Do you want to replace it?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel" class="bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-lg shadow-lg z-50 hidden opacity-0 transition-opacity duration-300"><p id="message-text"></p></div>
    <div id="help-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
            <h4 class="text-2xl font-bold mb-4 text-white">Insta-Clone Help</h4>
            <div id="help-content" class="flex-1 overflow-y-auto text-gray-300 space-y-4 pr-4"></div>
            <div class="flex justify-end mt-6">
                <button id="help-close-button" class="bg-purple-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-purple-700">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // --- Core Application Logic ---
        
        const $ = (selector) => document.querySelector(selector);
        
        const inputArea = $('#inputArea');
        const highlightingArea = $('#highlightingArea');
        const outputArea = $('#outputArea');
        const eraseButton = $('#eraseButton');
        const calculationNameInput = $('#calculationNameInput');
        const autocompletePopup = $('#autocomplete-popup');
        const confirmModal = $('#confirm-modal');
        const messageBox = $('#message-box');
        const roundingToggle = $('#roundingToggle');
        const noSleepToggle = $('#noSleepToggle');
        const cleanViewToggle = $('#cleanViewToggle');
        const helpButton = $('#helpButton');
        const helpModal = $('#help-modal');
        const helpContent = $('#help-content');
        const helpCloseButton = $('#help-close-button');
        const saveToFileButton = $('#saveToFileButton');
        const loadFromFileButton = $('#loadFromFileButton');
        const fileLoaderInput = $('#fileLoader');
        const shareButton = $('#shareButton');
        const toggleControlsButton = $('#toggleControlsButton');
        const controlsPanel = $('#controls-panel');

        let variables = {};
        let wakeLock = null;
        let autocompleteState = { active: false, suggestions: [], selectedIndex: -1, wordStartIndex: -1, currentWord: '' };
        
        const HELP_CONTENT_INPUT = `// Example with a loop\ntotal_sum = 0\nfor i = 1 to 3\n  total_sum = total_sum + i // running total\nendfor\n\n// Final result is above.\nfinal_value = total_sum * 2`;
        const HELP_CONTENT_POPUP_HTML = `
            <p>Welcome to Insta-Clone! This is a real-time calculator that understands variables, loops, and more. Type on the left and see the results on the right.</p>
            <h5>Getting Started: The Basics</h5><p><strong>Variables:</strong> Names are <strong>not case-sensitive</strong> (so <code>rent</code> and <code>Rent</code> are the same).</p><code>rent = 1200\nutilities = 250\ntotal_cost = Rent + utilities</code>
            <p><strong>Math Operations:</strong> Use standard operators like <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code> and group with parentheses <code>()</code>.</p><code>(100 - 25) * 2</code>
            <p><strong>Comments:</strong> Use <code>//</code> to add notes. Anything after it on a line is ignored.</p><code>income = 5000 // Gross monthly salary</code>
            <h5>Advanced Calculations</h5><p><strong>Percentages:</strong> Easily add, subtract, or find a percentage.</p><code>500 + 10%       // Adds 10% of 500\n120 - 25%       // Subtracts 25% of 120\n15% of 300      // Calculates 15% of 300</code>
            <p><strong>Date Math:</strong> Use the <code>today</code> keyword to find future or past dates.</p><code>project_due = today + 90 days\nlast_meeting = today - 3 weeks</code>
            <p><strong>Unit Conversions:</strong> Convert values using the format: <code>value from_unit to to_unit</code>.</p><code>100 usd to gbp\n2.5 m to ft\n10 cm to inch</code>
            <h5>Automating with Loops</h5><p><strong>For Loops:</strong> Run code multiple times with <code>for variable = start to end</code> and finish with <code>endfor</code>.</p><code>total = 0\nfor i = 1 to 5\n  total = total + i\nendfor</code>
            <h5>Managing Your Work</h5><p><strong>Calculation Name:</strong> Edit the name at the top-left. This is used when saving to a file.</p><p><strong>Quick Save & Load:</strong> Use the "Save 1/2/3" and "Load 1/2/3" buttons for quick storage in your browser.</p><p><strong>Save & Load from File:</strong> Use "Save to File" to download your work. Use "Load from File" to open it later.</p><p><strong>Share:</strong> Click "Share" to copy a unique link to your clipboard. Anyone with the link will see your exact calculation.</p>
            <h5>Interface & Tips</h5><p><strong>Autocomplete:</strong> Start typing a variable or keyword and a suggestion box will appear. Press <strong>Tab</strong> or <strong>Enter</strong> to accept.</p><p><strong>Line Highlighting:</strong> Hover your mouse over a line in the Results panel to see the corresponding input line highlighted.</p><p><strong>Collapsible Results:</strong> In the Results panel, click the '►' icon on a loop header to expand or collapse its output.</p><p><strong>Rounding Toggle:</strong> Enable this to format all decimal results to two decimal places.</p><p><strong>No Sleep Toggle:</strong> Enable this to prevent your device's screen from turning off.</p>
        `;

        const inchRates = { cm: 2.54, m: 0.0254, ft: 1/12 };
        const conversionRates = {
            usd: { eur: 0.92, gbp: 0.78 }, eur: { usd: 1.09, gbp: 0.85 }, gbp: { usd: 1.28, eur: 1.17 },
            m: { ft: 3.28084, cm: 100, in: 39.3701, inch: 39.3701 }, ft: { m: 0.3048, cm: 30.48, in: 12, inch: 12 }, cm: { m: 0.01, ft: 0.0328084, in: 0.393701, inch: 0.393701 }, in: inchRates, inch: inchRates,
            kg: { lb: 2.20462 }, lb: { kg: 0.453592 },
        };

        const specialWords = {
            'today': 'keyword', 'to': 'keyword', 'for': 'keyword', 'endfor': 'keyword', 'of': 'keyword',
            'usd': 'unit', 'eur': 'unit', 'gbp': 'unit', 'm': 'unit', 'ft': 'unit', 'cm': 'unit', 'kg': 'unit', 'lb': 'unit', 'in': 'unit', 'inch': 'unit',
            'days': 'unit', 'day': 'unit', 'weeks': 'unit', 'week': 'unit', 'months': 'unit', 'month': 'unit', 'years': 'unit', 'year': 'unit', 'hours': 'unit', 'hour': 'unit', 'minutes': 'unit', 'minute': 'unit',
        };

        // --- Helper Functions ---
        const setDefaultCalculationName = () => { const today = new Date(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); const yy = today.getFullYear().toString().slice(-2); calculationNameInput.value = `Insta-Clone ${mm}-${dd}-${yy}`; };
        const showMessage = (text) => { $('#message-text').textContent = text; messageBox.classList.remove('hidden'); setTimeout(() => messageBox.classList.remove('opacity-0'), 10); setTimeout(() => { messageBox.classList.add('opacity-0'); setTimeout(() => messageBox.classList.add('hidden'), 3000); }, 3000); };
        
        // --- Core Calculation Engine ---
        const calculate = (expression) => { if (!expression) return undefined; const pOfMatch = expression.match(/(\d+(?:\.\d+)?)%\s*of\s*(\d+(?:\.\d+)?)/i); if (pOfMatch) { const [, perc, num] = pOfMatch; return (parseFloat(perc) / 100) * parseFloat(num); } const convMatch = expression.match(/(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\s*to\s*([a-zA-Z]+)$/); if (convMatch) { const [, v, from, to] = convMatch.map(s => s.toLowerCase()); if (conversionRates[from]?.[to]) return parseFloat(v) * conversionRates[from][to]; return `Error: Unsupported conversion.`; } expression = expression.replace(/(\d+(?:\.\d+)?)\s*([+\-*/])\s*(\d+(?:\.\d+)?)%/g, (m, b, op, p) => (op === '+' || op === '-') ? `${b} ${op} (${b} * ${parseFloat(p) / 100})` : `${b} ${op} ${parseFloat(p) / 100}`); try { const result = new Function(`return ${expression}`)(); return (typeof result === 'number' && !isNaN(result)) ? result : undefined; } catch { return undefined; } };
        const replaceVariables = (expr) => Object.keys(variables).sort((a, b) => b.length - a.length).reduce((e, key) => e.replace(new RegExp(`\\b${key}\\b`, 'gi'), variables[key]), expr);
        const evaluateLine = (line) => {
            const commentIndex = line.indexOf('//');
            let code = (commentIndex !== -1) ? line.substring(0, commentIndex) : line;
            code = code.trim();

            if (!code || code.startsWith('for') || code.toLowerCase() === 'endfor') return null;
            const assignMatch = code.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);
            if (assignMatch) {
                const [, varName, expr] = assignMatch;
                const result = calculate(replaceVariables(expr.trim()));
                variables[varName.toLowerCase()] = result;
                return result;
            }
            const dateMatch = code.match(/^today\s*([+\-])\s*([a-zA-Z_]\w*|\d+)\s*(days?|weeks?|months?|years?)$/i);
            if (dateMatch) {
                const [, op, val, unit] = dateMatch;
                const num = isNaN(val) ? parseInt(variables[val.toLowerCase()], 10) : parseInt(val, 10);
                if (isNaN(num)) return `Error: Invalid number.`;
                const today = new Date();
                const mult = op === '+' ? 1 : -1;
                const u = unit.toLowerCase();
                if (u.startsWith('day')) today.setDate(today.getDate() + num * mult);
                else if (u.startsWith('week')) today.setDate(today.getDate() + num * 7 * mult);
                else if (u.startsWith('month')) today.setMonth(today.getMonth() + num * mult);
                else if (u.startsWith('year')) today.setFullYear(today.getFullYear() + num * mult);
                return today.toDateString();
            }
            return calculate(replaceVariables(code));
        };
        const formatResult = (r) => { if (typeof r === 'number' && roundingToggle.checked && !Number.isInteger(r)) return r.toFixed(2); return (r === undefined || r === null) ? '' : r; };

        // --- Syntax Highlighting Logic ---
        const highlightText = (line, definedVars) => { const escapeHtml = (t) => t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); const cIdx = line.indexOf('//'); const code = cIdx !== -1 ? line.substring(0, cIdx) : line; const comment = cIdx !== -1 ? `<span class="comment">${escapeHtml(line.substring(cIdx))}</span>` : ''; const varNameOnLine = (code.trim().match(/^([a-zA-Z_]\w*)\s*=/) || [])[1]?.toLowerCase(); const tokens = code.split(/(\b[a-zA-Z_]\w*\b|=|\s+)/).filter(Boolean); const processed = tokens.map(t => { const trimmed = t.trim().toLowerCase(); if (!t.trim()) return t; if (t === '=') return `<span class="operator">${t}</span>`; if (specialWords[trimmed]) return `<span class="${specialWords[trimmed]}">${escapeHtml(t)}</span>`; if (trimmed === varNameOnLine) return `<span class="${definedVars.has(trimmed) ? 'variable-redefined' : 'variable-new'}">${escapeHtml(t)}</span>`; if (definedVars.has(trimmed)) return `<span class="variable-used">${escapeHtml(t)}</span>`; return escapeHtml(t); }).join(''); return processed + comment; };

        // --- Main Processing Function ---
        const processAndHighlight = () => {
            const text = inputArea.value;
            const lines = text.split('\n');
            const isCleanView = cleanViewToggle.checked;

            // 1. Update Highlighting Layer
            const definedVarsForHighlight = new Set();
            const highlightedHTML = lines.map((line, index) => {
                const highlightedLine = highlightText(line, definedVarsForHighlight);
                const varNameMatch = line.trim().match(/^([a-zA-Z_]\w*)\s*=/);
                if (varNameMatch) { definedVarsForHighlight.add(varNameMatch[1].toLowerCase()); }
                return `<div data-line-id="${index}">${highlightedLine || '<br>'}</div>`;
            }).join('');
            highlightingArea.innerHTML = highlightedHTML;

            // 2. Update Calculation Results
            variables = {}; let outputHTML = ''; let loopIdCounter = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                const forLoopMatch = trimmedLine.match(/^for\s+([a-zA-Z_]\w*)\s*=\s*(.*?)\s+to\s+(.*?)\s*$/i);

                if (forLoopMatch) {
                    let endforIndex = -1; let nestingLevel = 0;
                    for (let j = i + 1; j < lines.length; j++) { if (lines[j].trim().match(/^for\s/i)) nestingLevel++; if (lines[j].trim().toLowerCase() === 'endfor') { if (nestingLevel === 0) { endforIndex = j; break; } else { nestingLevel--; } } }
                    if (endforIndex === -1) { if (!isCleanView) { outputHTML += `<div class="text-red-400 output-line" data-line-id="${i}">Error: Missing 'endfor'.</div>`; } continue; }

                    const [, iterator, startExpr, endExpr] = forLoopMatch; const iteratorLower = iterator.toLowerCase();
                    const startValue = Math.round(calculate(replaceVariables(startExpr.trim()))); const endValue = Math.round(calculate(replaceVariables(endExpr.trim())));
                    
                    if (!isCleanView) { // --- NORMAL VIEW LOOP LOGIC ---
                        loopIdCounter++; const loopBodyId = `loop-body-${loopIdCounter}`;
                        const highlightedHeader = highlightText(line, new Set(Object.keys(variables)));
                        outputHTML += `<div class="loop-header output-line" data-line-id="${i}" data-target-id="${loopBodyId}"><span class="toggle-icon">►</span><div class="flex items-start output-highlight flex-1"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedHeader}</span></div></div>`;
                        let loopBodyHTML = '';
                        if (isNaN(startValue) || isNaN(endValue)) { loopBodyHTML = `<div class="text-red-400 ml-8">Error: Loop bounds must be numbers.</div>`; } 
                        else {
                            const loopBodyLines = lines.slice(i + 1, endforIndex);
                            for (let k = startValue; k <= endValue; k++) {
                                variables[iteratorLower] = k;
                                loopBodyLines.forEach(bodyLine => {
                                    const result = evaluateLine(bodyLine);
                                    const highlightedBodyLine = highlightText(bodyLine, new Set(Object.keys(variables)));
                                    if (result !== null && result !== undefined) { loopBodyHTML += `<div class="flex items-start output-highlight ml-8"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1">${highlightedBodyLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`; } 
                                    else if (bodyLine.trim()) { loopBodyHTML += `<div class="flex items-start output-highlight ml-8"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedBodyLine}</span></div>`; } 
                                    else { loopBodyHTML += `<div class="h-6 ml-8"></div>`; }
                                });
                            }
                        }
                        delete variables[iteratorLower];
                        loopBodyHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${endforIndex}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightText(lines[endforIndex], new Set(Object.keys(variables)))}</span></div>`;
                        outputHTML += `<div id="${loopBodyId}" class="loop-body hidden">${loopBodyHTML}</div>`;
                    } else { // --- CLEAN VIEW LOOP LOGIC (SILENT EXECUTION) ---
                        if (!isNaN(startValue) && !isNaN(endValue)) {
                            const loopBodyLines = lines.slice(i + 1, endforIndex);
                            for (let k = startValue; k <= endValue; k++) {
                                variables[iteratorLower] = k;
                                loopBodyLines.forEach(bodyLine => { evaluateLine(bodyLine); });
                            }
                        }
                        delete variables[iteratorLower];
                    }
                    i = endforIndex; // Jump iterator past the processed loop
                } else if (trimmedLine.toLowerCase() === 'endfor') {
                    if (!isCleanView) outputHTML += `<div class="text-red-400 output-line" data-line-id="${i}">Error: Unexpected 'endfor'.</div>`;
                } else { // --- NON-LOOP LINE LOGIC ---
                    const lineVars = new Set(Object.keys(variables));
                    const result = evaluateLine(line);
                    
                    if (isCleanView) {
                        const commentIndex = line.indexOf('//');
                        const codePart = (commentIndex !== -1) ? line.substring(0, commentIndex) : line;
                        const trimmedCode = codePart.trim();
                        const commentText = (commentIndex !== -1) ? line.substring(commentIndex + 2).trim() : null;
                        const assignmentMatch = trimmedCode.match(/^([a-zA-Z_]\w*)\s*=\s*(.*)$/);

                        let lineHTML = '';
                        if (assignmentMatch) {
                            const varName = assignmentMatch[1];
                            const varClass = lineVars.has(varName.toLowerCase()) ? 'variable-redefined' : 'variable-new';
                            const resultPart = `<span><span class="${varClass}">${varName}</span><span class="operator"> = </span><span class="text-green-400 font-bold">${formatResult(result)}</span></span>`;
                            const commentPart = commentText ? `<span class="text-yellow-400 italic text-right pl-4">${commentText}</span>` : '';
                            lineHTML = `<div class="flex justify-between items-start output-highlight output-line py-1" data-line-id="${i}">${resultPart}${commentPart}</div>`;
                        } else if (trimmedCode && result !== null && result !== undefined) {
                            const resultPart = `<span class="text-gray-400">= </span><span class="text-green-400">${formatResult(result)}</span>`;
                            const commentPart = commentText ? `<span class="text-yellow-400 italic pl-4">${commentText}</span>` : '';
                            lineHTML = `<div class="flex justify-end items-start output-highlight output-line py-1" data-line-id="${i}"><span>${resultPart}${commentPart}</span></div>`;
                        } else if (commentText && !trimmedCode) {
                            lineHTML = `<div class="text-yellow-400 italic py-1 output-line" data-line-id="${i}">${commentText}</div>`;
                        } else if (trimmedCode) {
                            lineHTML = `<div class="py-1 output-line" data-line-id="${i}">${highlightText(line, lineVars)}</div>`;
                        } else if (!trimmedLine) {
                            lineHTML = `<div class="h-6 output-line" data-line-id="${i}"></div>`;
                        }
                        outputHTML += lineHTML;
                    } else {
                        if (!trimmedLine) { outputHTML += `<div class="h-6 output-line" data-line-id="${i}"></div>`; } 
                        else {
                            const highlightedLine = highlightText(line, lineVars);
                            if (result !== null && result !== undefined) { outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-blue-400 font-bold">></span><span class="flex-1">${highlightedLine}</span><span class="flex-1 text-right text-gray-400">= <span class="text-green-400">${formatResult(result)}</span></span></div>`; } 
                            else { outputHTML += `<div class="flex items-start output-highlight output-line" data-line-id="${i}"><span class="mr-4 text-gray-400 font-bold">></span><span class="flex-1">${highlightedLine}</span></div>`; }
                        }
                    }
                }
            }
            outputArea.innerHTML = outputHTML || '<div class="text-gray-400">Your results will appear here in real-time.</div>';
        };

        // --- Autocomplete Logic ---
        const getAutocompleteKeywords = (textContent) => { const orderedVars = []; textContent.split('\n').forEach(line => { const match = line.trim().match(/^([a-zA-Z_]\w*)\s*=/); if (match) { const varName = match[1].toLowerCase(); const existingIndex = orderedVars.indexOf(varName); if (existingIndex > -1) orderedVars.splice(existingIndex, 1); orderedVars.push(varName); } }); const newestVarsFirst = orderedVars.reverse(); const specialKeywordsList = Object.keys(specialWords); return [...newestVarsFirst, ...specialKeywordsList.filter(k => !orderedVars.includes(k))]; };
        
        function updateAutocompletePopup() {
            if (!autocompleteState.active || autocompleteState.suggestions.length === 0) { return autocompletePopup.classList.add('hidden'); }
            autocompletePopup.innerHTML = autocompleteState.suggestions.map((s, i) => `<div class="autocomplete-item ${i === autocompleteState.selectedIndex ? 'selected' : ''}" data-index="${i}">${s}</div>`).join('');
            const mirror = $('#autocomplete-mirror'); const text = inputArea.value; const cursorPos = inputArea.selectionStart;
            mirror.style.width = `${inputArea.clientWidth}px`; mirror.scrollTop = inputArea.scrollTop;
            const textBeforeCursor = text.substring(0, cursorPos); mirror.textContent = textBeforeCursor;
            const marker = document.createElement('span'); marker.innerHTML = '&nbsp;'; mirror.appendChild(marker);
            const lineHeight = parseFloat(getComputedStyle(inputArea).lineHeight);
            let left = marker.offsetLeft; let top = marker.offsetTop - inputArea.scrollTop + lineHeight;
            mirror.textContent = '';
            const inputContainerRect = inputArea.parentElement.getBoundingClientRect();
            autocompletePopup.style.left = `${left}px`; autocompletePopup.style.top = `${top}px`;
            if (top + autocompletePopup.offsetHeight > inputContainerRect.height) { autocompletePopup.style.top = `${top - lineHeight - autocompletePopup.offsetHeight - 5}px`; }
            autocompletePopup.classList.remove('hidden');
        }

        function closeAutocomplete() { autocompleteState.active = false; autocompletePopup.classList.add('hidden'); }
        function handleAutocomplete() { const text = inputArea.value; const cursorPos = inputArea.selectionStart; const textBeforeCursor = text.substring(0, cursorPos); if (/\s$/.test(textBeforeCursor) || textBeforeCursor.length === 0) return closeAutocomplete(); const wordMatch = textBeforeCursor.match(/(\w+)$/); if (!wordMatch) return closeAutocomplete(); autocompleteState.currentWord = wordMatch[1]; const lowerCurrentWord = autocompleteState.currentWord.toLowerCase(); autocompleteState.wordStartIndex = cursorPos - autocompleteState.currentWord.length; const suggestions = getAutocompleteKeywords(text).filter(kw => kw.toLowerCase().startsWith(lowerCurrentWord) && kw.toLowerCase() !== lowerCurrentWord); if (suggestions.length > 0) { autocompleteState.active = true; autocompleteState.suggestions = suggestions; autocompleteState.selectedIndex = 0; } else { closeAutocomplete(); } updateAutocompletePopup(); }
        function acceptSuggestion(suggestion) { const { value, selectionStart } = inputArea; const { wordStartIndex } = autocompleteState; const textBefore = value.substring(0, wordStartIndex); const textAfter = value.substring(selectionStart); const newText = `${textBefore}${suggestion} ${textAfter}`; inputArea.value = newText; const newCursorPos = wordStartIndex + suggestion.length + 1; inputArea.selectionStart = newCursorPos; inputArea.selectionEnd = newCursorPos; closeAutocomplete(); inputArea.focus(); inputArea.dispatchEvent(new Event('input', { bubbles: true })); }
        
        // --- Event Listeners ---
        inputArea.addEventListener('input', () => { processAndHighlight(); handleAutocomplete(); });
        inputArea.addEventListener('scroll', () => { highlightingArea.scrollTop = inputArea.scrollTop; highlightingArea.scrollLeft = inputArea.scrollLeft; });
        roundingToggle.addEventListener('change', processAndHighlight);
        cleanViewToggle.addEventListener('change', processAndHighlight);
        inputArea.addEventListener('keydown', (event) => { if (autocompleteState.active) { if (['ArrowDown', 'ArrowUp', 'Escape', 'Enter', 'Tab'].includes(event.key)) { event.preventDefault(); if (event.key === 'ArrowDown') { autocompleteState.selectedIndex = (autocompleteState.selectedIndex + 1) % autocompleteState.suggestions.length; updateAutocompletePopup(); } else if (event.key === 'ArrowUp') { autocompleteState.selectedIndex = (autocompleteState.selectedIndex - 1 + autocompleteState.suggestions.length) % autocompleteState.suggestions.length; updateAutocompletePopup(); } else if (event.key === 'Escape') { closeAutocomplete(); } else if (event.key === 'Enter' || event.key === 'Tab') { acceptSuggestion(autocompleteState.suggestions[autocompleteState.selectedIndex]); } return; } } });
        document.addEventListener('click', (e) => !autocompletePopup.contains(e.target) && closeAutocomplete());
        autocompletePopup.addEventListener('click', (e) => { const item = e.target.closest('.autocomplete-item'); if(item) acceptSuggestion(autocompleteState.suggestions[parseInt(item.dataset.index)]); });
        eraseButton.addEventListener('click', () => { inputArea.value = ''; processAndHighlight(); setDefaultCalculationName(); showMessage('Calculator cleared!'); });
        outputArea.addEventListener('click', (e) => { const header = e.target.closest('.loop-header'); if (header) { const targetId = header.dataset.targetId; const body = $(`#${targetId}`); const icon = header.querySelector('.toggle-icon'); if (body) { body.classList.toggle('hidden'); icon.classList.toggle('expanded'); icon.innerHTML = icon.classList.contains('expanded') ? '▼' : '►'; } } });
        toggleControlsButton.addEventListener('click', () => { controlsPanel.classList.toggle('hidden'); });

        // --- Save/Load and other features ---
        for (let i = 1; i <= 3; i++) { $(`#save-${i}`).addEventListener('click', () => { const key = `instacalc_slot_${i}`; const data = { name: calculationNameInput.value, content: inputArea.value }; if (localStorage.getItem(key)) { confirmModal.classList.add('flex'); confirmModal.classList.remove('hidden'); $('#confirm-ok').onclick = () => { localStorage.setItem(key, JSON.stringify(data)); confirmModal.classList.add('hidden'); showMessage(`Saved to slot ${i}!`); }; $('#confirm-cancel').onclick = () => confirmModal.classList.add('hidden'); } else { localStorage.setItem(key, JSON.stringify(data)); showMessage(`Saved to slot ${i}!`); } }); $(`#load-${i}`).addEventListener('click', () => { const saved = localStorage.getItem(`instacalc_slot_${i}`); if (saved) { try { const data = JSON.parse(saved); calculationNameInput.value = data.name || 'Insta-Clone'; inputArea.value = data.content || ''; } catch (e) { inputArea.value = saved; setDefaultCalculationName(); } processAndHighlight(); showMessage(`Loaded from slot ${i}!`); } else { showMessage(`Slot ${i} is empty.`); } }); }
        saveToFileButton.addEventListener('click', () => { const data = { name: calculationNameInput.value, content: inputArea.value }; if (!data.content.trim()) { showMessage('Nothing to save!'); return; } const sanitized = (calculationNameInput.value.trim() || 'Calculation').replace(/[\/\\?%*:|"<>]/g, '').replace(/\s+/g, '_'); const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `IC_${sanitized}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showMessage('File download started!'); });
        loadFromFileButton.addEventListener('click', () => { fileLoaderInput.click(); });
        fileLoaderInput.addEventListener('change', (event) => { if (!event.target.files.length) return; const file = event.target.files[0]; const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; try { const data = JSON.parse(content); if (data?.content !== undefined) { calculationNameInput.value = data.name || 'Insta-Clone'; inputArea.value = data.content; } else { throw new Error("Not our format"); } } catch (err) { inputArea.value = content; calculationNameInput.value = file.name.replace(/\.[^/.]+$/, ""); } processAndHighlight(); showMessage(`File "${file.name}" loaded!`); }; reader.onerror = () => showMessage(`Error reading file.`); reader.readAsText(file); event.target.value = null; });
        shareButton.addEventListener('click', () => { const data = { name: calculationNameInput.value, content: inputArea.value }; if (!data.content.trim()) { showMessage('Nothing to share!'); return; } try { const compressed = pako.deflate(JSON.stringify(data)); let bin = ''; for (let i = 0; i < compressed.length; i++) bin += String.fromCharCode(compressed[i]); const url = `${location.origin}${location.pathname}?data=${encodeURIComponent(btoa(bin))}`; navigator.clipboard.writeText(url).then(() => showMessage('Share link copied!'), () => showMessage('Failed to copy.')); } catch (e) { showMessage('Could not create share link.'); } });
        noSleepToggle.addEventListener('change', async (e) => { if (e.target.checked) { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', () => { if(e.target.checked) { e.target.checked = false; showMessage('Wake lock released.'); }}); showMessage('Screen wake lock active.'); } catch (err) { showMessage(`Error: ${err.message}`); e.target.checked = false; } } else { showMessage('Wake Lock API not supported.'); e.target.checked = false; } } else if (wakeLock) { wakeLock.release(); wakeLock = null; } });
        helpButton.addEventListener('click', () => { helpModal.classList.remove('hidden'); helpModal.classList.add('flex'); });
        helpCloseButton.addEventListener('click', () => { helpModal.classList.add('hidden'); helpModal.classList.remove('flex'); });

        // --- Line Highlighting Logic ---
        const clearHighlights = () => { document.querySelectorAll('.line-highlight').forEach(el => el.classList.remove('line-highlight')); };
        outputArea.addEventListener('mouseover', (e) => { const targetLine = e.target.closest('.output-line'); if (targetLine) { clearHighlights(); const lineId = targetLine.dataset.lineId; if (lineId) { const inputLine = $(`#highlightingArea [data-line-id="${lineId}"]`); if (inputLine) { inputLine.classList.add('line-highlight'); targetLine.classList.add('line-highlight'); } } } });
        outputArea.addEventListener('mouseout', () => { clearHighlights(); });

        // --- Initial Page Load ---
        window.addEventListener('DOMContentLoaded', () => {
            helpContent.innerHTML = HELP_CONTENT_POPUP_HTML.replace(/\\n/g, '\n');
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            let loadedFromUrl = false;
            if (sharedData) {
                try {
                    let binaryString = atob(decodeURIComponent(sharedData));
                    const uint8array = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) uint8array[i] = binaryString.charCodeAt(i);
                    const data = JSON.parse(pako.inflate(uint8array, { to: 'string' }));
                    if (data?.content !== undefined) {
                        calculationNameInput.value = data.name || 'Insta-Clone';
                        inputArea.value = data.content;
                        loadedFromUrl = true;
                        showMessage('Loaded shared calculation!');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { showMessage('Could not load data from link.'); }
            }
            if (!loadedFromUrl) {
                inputArea.value = HELP_CONTENT_INPUT;
                setDefaultCalculationName(); 
            }
            processAndHighlight();
        });
    </script>
</body>
</html>
